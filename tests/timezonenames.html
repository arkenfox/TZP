<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>timezonenames</title>
<style>
</style>
</head>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=800">
	<title>pluralrules</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 780px;}
		hr {color: #dcdc8c}
	</style>
</head>
<body>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb4">
		<col width="32%"><col width="68%">
		<thead><tr><th colspan="2">
			<div class="nav-title">timeZoneName
			<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">Testing language results in timeZoneName</span>
		</td></tr>
		<tr>
			<td class="mono spaces" id="legend" style="text-align: left; vertical-align: top; color: #b3b3b3; font-size: 11px"></td>
			<td class="mono" style="text-align: left; vertical-align: top;">
				<span id="b0" class="btn4 btnfirst" onClick="run('0')">[ S ]</span>
				<span id="b1" class="btn4 btn" onClick="run('1')">[ L ]</span>
				<span id="b2" class="btn4 btn" onClick="run('2')">[ SO ]</span>
				<span id="b3" class="btn4 btn" onClick="run('3')">[ LO ]</span>
				<span id="b4" class="btn4 btn" onClick="run('4')">[ SG ]</span>
				<span id="b5" class="btn4 btn" onClick="run('5')">[ LG ]</span>
				<!--<span id="bALL" class="btn4 btn" onClick="run('ALL')">[ ALL ]</span>-->
			<br><br><hr><br>
				<span id ="results"></span>
			</td></tr>
	</table>
	<br>

<script>
'use strict';

var list = gLocales,
	aLegend = [],
	aLocales = []

s4 = s4.trim()
s12 = s12.trim()
s14 = s14.trim()
s16 = s16.trim()
sg = sg.trim()
sb = sb.trim()
s99 = s99.trim()

function legend() {
	// build once
	if (aLegend.length == 0) {
		list.sort()
		for (let i = 0 ; i < list.length; i++) {
			let str = list[i].toLowerCase()
			let code = str.split(",")[0].trim()
			let name = str.split(",")[1].trim()
			let test = Intl.DateTimeFormat.supportedLocalesOf([code])
			if (test.length) {
				aLocales.push(code)
				let isSplit = (name.includes("(") && (name.length + code.length) > 32)
				if (name.includes("(")) {
					let name0 = name.split("(")[0].trim()
					let name1 = name.substring(
						name.indexOf("(") + 1, 
						name.lastIndexOf(")")
					)
					name1 = s99 +"("+ name1 + ")"+ sc
					if (isSplit) {
						name = name0 +"<br>"+ " ".repeat(4) + name1
					} else {
						name = name0 +" "+ name1
					}
				}
				aLegend.push(code.padStart(7) +": "+ name)
			}
		}
	}
	// output
	let	header = s4 +"   LEGEND ["+ aLegend.length + " supported]"+ sc +"<br><br>"
	dom.legend.innerHTML = header + aLegend.join("<br>")
}

function run_main(type) {
	let t0 = performance.now()
	let data = []
	let tzUnknown = []
	let tzTZN = []

	let tzNames = ["short","long","shortOffset","longOffset","shortGeneric","longGeneric"]
	let tzDays = [Date.UTC(2019, 1, 1, 13, 0, 0), Date.UTC(2019, 7, 1, 0, 0, 0)]
	let spacer = "<br><br>"
	
	if (type !== "ALL") {
		let tmp = tzNames[type]
		tzNames = [tmp]
	}

	function getTZNames(code) {
		// note: use hour12 - https://bugzilla.mozilla.org/show_bug.cgi?id=1645115#c9
		let tzRes = []
		try {
			tzDays.forEach(function(day) {
				tzNames.forEach(function(name) {
					let tz = ""
					try {
						let tzFormatter = Intl.DateTimeFormat(code, {hour12: true, timeZoneName: name})
						let tzDateString = tzFormatter.formatToParts(day).map(({type, value}) => {
							// FF91: extended TZNs are type "unknown"
							if (type == "timeZoneName" || type == "unknown") {
								tz = value
							}
							if (type == "timeZoneName") {tzTZN.push(code +": "+ type + " :"+ value)}
							if (type == "unknown") {tzUnknown.push(code +": "+ type + " :"+ value)}
							return type +":"+ value
						})
						//console.debug(tzDateString, code)
					} catch(e) {
						tz = zErr
					}
					tzRes.push(tz)
				})
			})
			return tzRes.join(", ")
		} catch(e) {
			return zErr
		}
	}

	try {
		// get data
		aLocales.forEach(function(code) {
			let res = getTZNames(code)
			if (res.length > 0) {
				data.push(sha1(res) +":"+ code +":" + res)
			}
		})

		if (data.length) {
			// add undefined
			let res = getTZNames(undefined)
			data.push(sha1(res) +":undefined:" + res)

			// check types: FF91 extended timezonenames are type unknown
			//if (tzUnknown.length) {console.debug("type: unknown\n", tzUnknown)}
			//if (tzTZN.length) {console.debug("type: timeZoneName\n", tzTZN)}

			// get one line per hash
			data.sort()
			let next = "", codes = []
			let aHash = [], aBucketsR = [], aBucketsC = []
			for (let i = 0 ; i < data.length; i++) {
				// get current item
				let parts = data[i].split(":")
				let tmpH = parts[0]
				let tmpL = parts[1]
				let tmpR = parts.slice(2, parts.length).join(":")
				codes.push(tmpL)
				// grab next item
				if (i < data.length - 1) {
					next = data[(i+1)].substring(0,40)
				} else {
					next = "end"
				}
				// build new item
				if (next !== tmpH) {
					aBucketsR.push(tmpR) // hash of results
					aBucketsC.push(codes.join()) // hash of locale groups
					let str = s12 + tmpH + sc + s4 + " ["+ codes.length +"]"+ sc
						+ "<br><ul><li>" + s16 +"R: "+ sc + tmpR +"</li>"
						+ "<li>"+ s12 +"L: "+ sc + codes.join(", ") + "</li></ul>"
					aHash.push(str)
					codes = [] // reset
				}
			}
			// buckets
			aBucketsR.sort()
			aBucketsC.sort()
			if (type !== "ALL") {
				type = tzNames[0]
				dom.results.innerHTML = s4 + type.toUpperCase() +" ["+ aHash.length
					+ sc +" from "+ s4 + aLocales.length +" supported"+ sc +" + undefined"+ s4
					+"]"+ sc	+ spacer
					+ s16 +"results: "+ sc + sha1(aBucketsR.join()) +"<br>"
					+ s12 +"locales: "+ sc + sha1(aBucketsC.join()) + spacer
					+ aHash.join("<br>")
			}
		} else {
			if (type !== "ALL") {
				type = tzNames[0]
				dom.results.innerHTML = s4 + type.toUpperCase() + sc + spacer + "not supported"
			}
		}
		
		// perf
		dom.perf.innerHTML = Math.round(performance.now() - t0) +" ms"

	} catch(e) {
		dom.results.innerHTML = "<br>"+ s4 + e.name +": "+ sc + e.message
	}
}

function run(type) {
	//reset
	dom.results.innerHTML = "<br>running test..."
	dom.perf = ""
	legend()
	setBtn(type)
	// delay so users see change and allow paint
	setTimeout(function() {
		if (type == "ALL") {
			dom.results.innerHTML = "<br>not coming soon... it's too slow"
		} else {
			run_main(type * 1)
		}
	}, 1)
}

function setBtn(type) {
	// reset btns
	let items = document.getElementsByClassName("btn8")
	for (let i=0; i < items.length; i++) {
		items[i].classList.add("btn4")
		items[i].classList.remove("btn8")
	}
	// set btn
	let el = document.getElementById("b"+ type)
	el.classList.add("btn8")
	el.classList.remove("btn4")
}

legend()

</script>
</body>
</html>
