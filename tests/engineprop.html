<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=900">
	<title>engine properties</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<style>
		table {width: 90%; min-width: 600px; max-width: 880px}
		#tb3 td:first-child { text-align: left; vertical-align: top;}
	</style>
</head>

<body>
	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html#feature">return to TZP index</a></td></tr>
	</table>

	<table id="tb3">
		<col width="50%"><col width="50%">
		<thead><tr><th colspan="2">
			<div class="nav-title">engine properties
				<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="mono" style="text-align: left; vertical-align: top;">
			<span class="btn3 btnfirst" onClick="rerun()">[ run test ]</span>
			<span class="btn3 btn" onClick="logConsole(`list`)">[ log list ]</span> | 
			<span class="btn3 btn" onClick="scrape()">[ scrape ]</span> | 
			<span class="btn3 btn">
				<select name="items" id="items">
<option value="w">caches</option>
<option value="w">console</option>
<option value="w">crypto</option>
<option value="w">CSS</option>
<option value="p">CSS2Properties</option>
<option value="p">CSSStyleProperties</option>
<option value="p">CanvasRenderingContext2D</option>
<option value="w">clientInformation</option>
<option value="p">Element</option>
<option value="p">Headers</option>
<option value="w">navigator</option>
<option value="w">performance</option>
<option value="w">screen</option>
				</select> 
			<span onClick="get_engineItem()">[ run item ]</span>
			</span> | 
			<span class="btn3 btn" onClick="copyclip(`results`)">[ copy ]</span>
			<br><br>
			<hr>
			<br>
			<span class="spaces" style="color: #b3b3b3;" id="results"></span>
			</td>
		</tr>
	</table>
	<br>

<script>
'use strict';

let oTypes = {},
	aList = [],
	aNew = [], // level 1 items found in scrape not in the test
	aErr = [], // invalid group codes
	aType = [], // missing a typeof check
	tstart,
	padNum = 14,
	domresult = document.getElementById("results"),
	domperf = document.getElementById("perf"),
	s3 = "<span class='s3'>",
	s9 = "<span class='s9'>",
	s12 = "<span class='s12'>",
	s14 = "<span class='s14'>",
	s17 = "<span class='s17'>",
	sb = "<span class='bad'>",
	sg = "<span class='good'>",
	sc = "</span>",
	green_tick = "<span style='font-size: 10px;'><b>" + s9 +" \u2713"+ sc + "</b></span>",
	red_cross = "<span style='font-size: 10px;'><b>" + sb +" \u2715"+ sc + "</b></span>"

/** functions from generic **/
// we don't want to include globals or generic which will pollute scraping

function json_highlight(json) {
	if (typeof json != 'string') {
		json = json_stringify(json);
	}
	json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
	return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
		var cls = 'number';
		if (/^"/.test(match)) {
			if (/:$/.test(match)) {
				cls = 'key';
			} else {
				cls = 'string';
				// color undefined (aka "typeof undefined")
				//if (match == "\"typeof undefined\"") {cls = 'null';}
			}
		} else if (/true|false/.test(match)) {
			cls = 'boolean';
		} else if (/null/.test(match)) {
			cls = 'null';
		}
		return '<span class="'+ cls +'">'+ match +'</span>';
	})
}

function json_stringify(passedObj, options = {}) {
	/* https://github.com/lydell/json-stringify-pretty-compact */
	const stringOrChar = /("(?:[^\\"]|\\.)*")|[:,]/g;
	const indent = JSON.stringify(
		[1],
		undefined,
		options.indent === undefined ? 2 : options.indent
	).slice(2, -3);
	const maxLength =
		indent === ""
			? Infinity
			: options.maxLength === undefined
			? 65 // was 80
			: options.maxLength;
	let { replacer } = options;

	return (function _stringify(obj, currentIndent, reserved) {
		if (obj && typeof obj.toJSON === "function") {
			obj = obj.toJSON();
		}

		// display undefined under an alias so we always have the right number of values
		// this is just a display, it does not alter the fingerprint data
		//if (obj === undefined) {obj = "typeof undefined"}

		const string = JSON.stringify(obj, replacer);
		if (string === undefined) {
			return string;
		}
		const length = maxLength - currentIndent.length - reserved;
		if (string.length <= length) {
			const prettified = string.replace(
				stringOrChar,
				(match, stringLiteral) => {
					return stringLiteral || `${match} `;
				}
			);
			if (prettified.length <= length) {
				return prettified;
			}
		}
		if (replacer != null) {
			obj = JSON.parse(string);
			replacer = undefined;
		}
		if (typeof obj === "object" && obj !== null) {
			const nextIndent = currentIndent + indent;
			const items = [];
			let index = 0;
			let start;
			let end;
			if (Array.isArray(obj)) {
				start = "[";
				end = "]";
				const { length } = obj;
				for (; index < length; index++) {
					items.push(
						_stringify(obj[index], nextIndent, index === length - 1 ? 0 : 1) ||
						"null"
					);
				}
			} else {
				start = "{";
				end = "}";
				const keys = Object.keys(obj);
				const { length } = keys;
				for (; index < length; index++) {
					const key = keys[index];
					const keyPart = `${JSON.stringify(key)}: `;
					const value = _stringify(
						obj[key],
						nextIndent,
						keyPart.length + (index === length - 1 ? 0 : 1)
					);
					if (value !== undefined) {
						items.push(keyPart + value);
					}
				}
			}
			if (items.length > 0) {
				return [start, indent + items.join(`,\n${nextIndent}`), end].join(
				`\n${currentIndent}`
				);
			}
		}
	return string;
	})(passedObj, "", 0);
}

function mini(str) {
	// https://stackoverflow.com/a/22429679
	const json = `${JSON.stringify(str)}`
	let i, len, hash = 0x811c9dc5
	for (i = 0, len = json.length; i < len; i++) {
		hash = Math.imul(31, hash) + json.charCodeAt(i) | 0
	}
	return ('0000000' + (hash >>> 0).toString(16)).slice(-8)
}

function copyclip(element) {
	// fallback: e.g FF62-
	function copyExec() {
		if (document.selection) {
			let range = document.body.createTextRange()
			range.moveToElementText(document.getElementById(element))
			range.select().createTextRange()
			document.execCommand("copy")
		} else if (window.getSelection) {
			let range = document.createRange()
			range.selectNode(document.getElementById(element))
			window.getSelection().addRange(range)
			document.execCommand("copy")
		}
	}
	// clipboard API
	if ("clipboard" in navigator) {
		try {
			let content = document.getElementById(element).innerHTML
			// remove spans, change linebreaks
			let regex = /<br\s*[\/]?>/gi
			content = content.replace(regex, "\r\n")
			content = content.replace(/<\/?span[^>]*>/g,"")
			content = content.replace(/<\/?hr[^>]*>/g,"")
			// get it
			navigator.clipboard.writeText(content).then(function() {
				// clipboard successfully set
			}, function() {
				// clipboard write failed
				copyExec()
			})
		} catch(e) {
			copyExec()
		}
	} else {
		copyExec()
	}
}

/** function for this test **/

function collectProps () {
	const objCache = new Set();
	// skip these
	objCache.add(window.self);
	// prevent us decending into the DOM
	objCache.add(document);
	objCache.add(document.activeElement);
	//objCache.add(event?.currentTarget); // FF73 or lower this causes a syntax error
	if (self.event && event.currentTarget) objCache.add(event.currentTarget)

	const recursionAllowed = new Set();
	recursionAllowed.add('navigator');
	function extractObjectProps (obj, breadcrumbs = [], depth = 0) {
		if (depth >= 5) {
			return {};
		}
		const props = {};
		const proplist = [];
		for (const prop in obj) {
			proplist.push(prop);
		}
		proplist.sort().forEach((prop) => {
			try {
				const desc = Object.getOwnPropertyDescriptor(obj, prop) || {};
				desc.type = typeof obj[prop];
				if (desc.type === 'function') {
					desc.value = obj[prop].toString();
				} else if (desc.type === 'object' && prop !== "opener") {
					// don't enuemrate opener object
					if (!objCache.has(obj[prop]) || recursionAllowed.has(prop)) {
						objCache.add(obj[prop]);
						desc.properties = extractObjectProps(obj[prop], [...breadcrumbs, prop], depth + 1);
					}
					delete desc.value;
				}
				props[prop] = desc;
			} catch (e) {
				console.warn(`Error for ${breadcrumbs.join('.')}.${prop}`, e);
			}
		});
		return props;
	}
	return {
		window: extractObjectProps(window)
	}
}

function get_engineProp(item) {
	try {
		let objCache = new Set()
		let order = {}
		objCache.add(window.self)
		// prevent us decending into the DOM
		objCache.add(document);
		objCache.add(document.activeElement);
		//objCache.add(event?.currentTarget); // FF73 or lower this causes a syntax error
		if (self.event && event.currentTarget) objCache.add(event.currentTarget)
		function get_perf_props(item) {
			const recursionAllowed = new Set();
			recursionAllowed.add('navigator');
			function extractObjectProps (obj, breadcrumbs = [], depth = 0) {
				if (depth >= 5) {
					return {}
				}
				const props = {}
				const proplist = []
				for (const prop in obj) {
					proplist.push(prop)
				}
				let proptemp = []
				proplist.forEach((prop) => {
					proptemp.push(prop)
				})
				if (proptemp.length) {
					if ("object" === typeof obj && obj !== null) {
						let name = (obj+"").slice(8, -1)
						order[name] = {}
						order[name]["count"] = proptemp.length
						order[name]["hash"] = mini(proptemp)
						order[name]["data"] = proptemp
					}
				}
				proplist.sort().forEach((prop) => {
					try {
						const desc = Object.getOwnPropertyDescriptor(obj, prop) || {}
						if (typeof obj[prop] === 'function') {
							desc.length = obj[prop].toString().length
						}
						desc.type = typeof obj[prop]
						if (desc.type === 'function') {
							desc.value = obj[prop].toString()
						} else if (desc.type === 'object' && prop !== "opener") {
							// don't enuemrate opener object
							//if (!objCache.has(obj[prop])) { // || recursionAllowed.has(prop)) {
							if (!objCache.has(obj[prop]) || recursionAllowed.has(prop)) {
								objCache.add(obj[prop])
								desc.properties = extractObjectProps(obj[prop], [...breadcrumbs, prop], depth + 1)
							}
							delete desc.value
						}
						props[prop] = desc
					} catch (e) {
						console.warn(`Error for ${breadcrumbs.join('.')}.${prop}`, e)
					}
				})
				return props
			}
			return extractObjectProps(item)
		}
		let data = get_perf_props(item)
		let datahash = mini(data)
		let oData = {
			"data": {
				hash: datahash,
				metrics: data,
			}
		}
		if (Object.keys(order).length) {
			// reorder order
			let neworder = {}
			for (const k of Object.keys(order).sort()) {neworder[k] = order[k]}
			let orderhash = mini(neworder)
			oData["order"] = {"hash": orderhash, "metrics": neworder}
		}
		return oData
	} catch(e) {
		return e+""
	}
}

function get_engineItem() {
	domresult.innerHTML = ""
	domperf.innerHTML = ""

	setTimeout(function() {
		tstart = performance.now()
		let selection = document.getElementById("items")
		let type = selection.value
		let name = selection.options[selection.selectedIndex].text
		let displayname = s3 + name + sc + ": "
		let item

		try {
			if ("w" === type) {
				item = window[name]
			} else if ("p" === type) {
				item = window[name].prototype
			}
			if (item !== undefined) {
				let oData = get_engineProp(item)
				if ("string" == typeof oData) {
					domresult.innerHTML = displayname + oData
				} else {
					let hash = mini(oData)
					domperf.innerHTML = Math.round((performance.now() - tstart)) +" ms"
					domresult.innerHTML = displayname + hash + "<br><br>" + json_highlight(oData)
				}
			} else {
				domresult.innerHTML = displayname + "oophs... not coded yet"
			}
		} catch(e) {
			domresult.innerHTML = displayname + e+""
		}
	}, 170)
}

function logConsole(name) {
	let array = [], str = ""
	if (name == "list") { array = aList; str = "TEST LIST"
	}
	console.log(str +" [" + array.length +"]\n" + array.join("\n"))
}

function output() {
	domperf.innerHTML = Math.round((performance.now() - tstart)) +" ms | "+ aList.length +" items"
	aList.sort()
	let display = []
	for (const k of Object.keys(oTypes).sort()) {
		let group = oTypes[k]
		let gHash = []
		let gDisplay = []
		let gCount = 0
		let gCountUndefined = 0
		// get group details
		for (const n of Object.keys(group).sort()) {
			let data = group[n]
			data.sort()
			gCount += data.length
			if (data.length) {
				let tHash = mini(data)
				gHash.push(n +": "+ tHash)
				gDisplay.push(s3 + n.padStart(padNum) + sc +": "+ tHash + s3 +" ["+ data.length +"]"+ sc +"<br>")
				gDisplay.push(data.join(", ") + "<br>")
				if (n == "undefined") {
					gCountUndefined += data.length
				}
			}
		}
		if (gDisplay.length) {
			// get group hash
			let hashG = gHash.length ? mini(gHash) +" ["+ gCount +"]" : ""
			// add group header
			let strG = "", strExtra = "", strColor = s12
				//only
			if (k == 10) {strG = "BLINK ONLY"
			} else if (k == 11) { strG = "EDGEHTML ONLY"
			} else if (k == 12) { strG = "GECKO ONLY"
			} else if (k == 14) { strG = "WEBKIT ONLY"
				// in two but not the other
			} else if (k == 50) { strG = "BLINK + GECKO"; strColor = s14; strExtra = " [not webkit... yet]"
			} else if (k == 52) { strG = "BLINK + WEBKIT"; strColor = s14; strExtra = " [not gecko... yet]"
			} else if (k == 54) { strG = "GECKO + WEBKIT"; strColor = s14; strExtra = " [not blink... yet]"
				// the rest
			} else if (k == 98) { strG = "UNDETERMINED"; strColor = s17; strExtra = " to be assessed"
			} else if (k == 99) { strG = "IGNORE"; strColor = s17; strExtra = " confirmed in all three engines"
			}
			strG = strG.padStart(padNum)
			let header = strG + (gHash.length ? ": "+ hashG : "")
			// add a green "all undefined" - we should get at least three per engine
			let strU = ""
			if (gHash.length && k < 90) {
				if (gCount == gCountUndefined) {
					strU = " "+ green_tick + sg +" all "+ gCountUndefined +" undefined"+ sc
				}
			}
			display.push(strColor + header + strExtra + sc + strU +"<br>")
			// add group detail
			if (gHash.length) {
				display.push(gDisplay.join("<br>"))
			}
			// hr
			if (k < 99) {
				display.push("<br><hr>")
			}
		}
	}

	// DEV ALERTS
	let strAlert = ""
	// invalid group codes
	if (aErr.length) {
		strAlert += sb + "INVALID GROUP CODES: " + sc + aErr.join(", ") +"<br><br>"
	}
	// missing typeof parameter
	if (aType.length) {
		strAlert += sb + "MSSING TYPEOF CHECK: " + sc + aType.join(", ") +"<br><br>"
	}
	// dupes
	let aDupe = aList
	aList = aList.filter(function(item, position) {return aList.indexOf(item) === position})
	let hDupe = mini(aDupe.join())
	let hList = mini(aList.join())
	let strDupe = ""
	if (hList !== hDupe) {
		aDupe = aDupe.filter((item, index) => aDupe.indexOf(item) !== index)
		strAlert += sb + "DUPLICATES: " + sc + aDupe.join(", ") + "<br><br>"
	}
	// alerts
	if (strAlert !== "") {strAlert += "<hr><br>"}

	// function hash
		// gecko: 39: 334c4512 : function atob() {\n    [native code]\n}
		// blink: 33: 1dd1c7f6 : function atob() { [native code] }
		// edgehtml: 33: 1dd1c7f6 : function atob() { [native code] }
	let strF = ""
	try {
		let testF = atob.toString()
		testF = testF.replace(/\n/g,'\\n');
		let hashF = "length "+ testF.length + ": " + mini(testF)
		strF = s14 + ("FUNCTION").padStart(padNum) + sc +": "+ hashF + " : " + testF + "<br><br><hr><br>"
	} catch(e) {
		console.error(e.name, e.message)
	}
	// output
	let strM = s14 + ("MINI TEST").padStart(padNum) + sc + ": "+ isEnginePretty + "<br><br>"
	domresult.innerHTML = strAlert + strM + strF + display.join("<br>")
}

function rec(type, name, group = 98, expected) {
	aList.push(name)
	try {
		if (expected !== undefined) {
			if (type !== "undefined" && type !== expected) {
				name = sb + name +" ["+ expected +"]"+ sc
			}
		} else {
			// missing typeof parameter
			aType.push(name)
		}
		oTypes[group][type].push(name)
	} catch(e) {
		aErr.push(name)
		oTypes[98][type].push(name)
	}
}

function reset() {
	aList = []
	aErr = []
	aType = []
	domresult.innerHTML = ""
	oTypes = {}
	let groups = [10,11,12,14,50,52,54,98,99]
	let types = ["bigint","boolean","function","number","object","string","symbol","undefined",]
	groups.forEach(function(group) {
		oTypes[group] = {}
		types.forEach(function(type) {
			oTypes[group][type] = []
		})
	})
}

function rerun() {
	reset()
	// delay so user sees changes
	setTimeout(function() {
		run()
	}, 170)
}

function run() {
	try {
		tstart = performance.now()
		let code

		/* LEVEL ONE */
		// undetermined: status confirmed in EOL comments
		code = 98
		//rec(typeof keys, "keys", code) // NFI where I got this from

		// blink only
		code = 10
		rec(typeof Keyboard, "Keyboard", code, "function")
		rec(typeof KeyboardLayoutMap, "KeyboardLayoutMap", code, "function")
		rec(typeof PERSISTENT, "PERSISTENT", code, "number")
		rec(typeof TEMPORARY, "TEMPORARY", code, "number")
		rec(typeof chrome, "chrome", code, "object") // edgeHTML
		rec(typeof onappinstalled, "onappinstalled", code, "object")
		rec(typeof onbeforeinstallprompt, "onbeforeinstallprompt", code, "object")
		rec(typeof openDatabase, "openDatabase", code, "function")
		rec(typeof webkitRequestFileSystem, "webkitRequestFileSystem", code, "function")
		rec(typeof webkitResolveLocalFileSystemURL, "webkitResolveLocalFileSystemURL", code, "function")
			// android
		rec(typeof getDigitalGoodsService, "getDigitalGoodsService", code, "function")
			// not in Brave (or android)
		rec(typeof showDirectoryPicker, "showDirectoryPicker", code, "function")
		rec(typeof showOpenFilePicker, "showOpenFilePicker", code, "function")
		rec(typeof showSaveFilePicker, "showSaveFilePicker", code, "function")
			// newish: not in v90
		rec(typeof getScreenDetails, "getScreenDetails", code, "function")
		rec(typeof launchQueue, "launchQueue", code, "object") // + not in Brave (or android)
		rec(typeof onbeforexrselect, "onbeforexrselect", code, "object")
		rec(typeof queryLocalFonts, "queryLocalFonts", code, "function")
		rec(typeof sharedStorage, "sharedStorage", code, "object")
		// newish: since last check; testing chrome 119
		rec(typeof documentPictureInPicture, "documentPictureInPicture", code, "object")
		rec(typeof fence, "fence", code, "object")
		rec(typeof credentialless, "credentialless", code, "boolean")
			// other
		rec(typeof opr, "opr", code, "object") // OPERA (desktop at least)
		rec(typeof webkitStorageInfo, "webkitStorageInfo", code, "object") // to-be-deprecated see console
		// stuff showing up in scrape > new
		rec(typeof fetchLater, "fetchLater", code, "function")
		rec(typeof onpagereveal, "onpagereveal", code, "object")
		rec(typeof onpageswap, "onpageswap", code, "object")
		rec(typeof onscrollsnapchange, "onscrollsnapchange", code, "object")
		rec(typeof onscrollsnapchanging, "onscrollsnapchanging", code, "object")
		rec(typeof viewport, "viewport", code, "object")
		rec(typeof when, "when", code, "function")

		// edgeHTML only
		code = 11
		/* notes: has
			blink only: chrome, offscreenBuffering
			gecko only: ondevicelight, onvrdisplayactivate, onvrdisplayconnect, onvrdisplaydeactivate, onvrdisplaydisconnect, onvrdisplaypresentchange
			webkit only: browser, getMatchedCSSRules, webkitConvertPointFromNodeToPage, webkitConvertPointFromPageToNode
			also pairs are a mess
		*/
		rec(typeof clearImmediate, "clearImmediate", code, "function")
		rec(typeof msWriteProfilerMark, "msWriteProfilerMark", code, "function")
		rec(typeof oncompassneedscalibration, "oncompassneedscalibration", code, "object")
		rec(typeof onmsgesturechange, "onmsgesturechange", code, "object")
		rec(typeof onmsgesturedoubletap, "onmsgesturedoubletap", code, "object")
		rec(typeof onmsgestureend, "onmsgestureend", code, "object")
		rec(typeof onmsgesturehold, "onmsgesturehold", code, "object")
		rec(typeof onmsgesturestart, "onmsgesturestart", code, "object")
		rec(typeof onmsgesturetap, "onmsgesturetap", code, "object")
		rec(typeof onmsinertiastart, "onmsinertiastart", code, "object")
		rec(typeof onreadystatechange, "onreadystatechange", code, "object")
		rec(typeof onvrdisplayblur, "onvrdisplayblur", code, "object")
		rec(typeof onvrdisplayfocus, "onvrdisplayfocus", code, "object")
		rec(typeof onvrdisplaypointerrestricted, "onvrdisplaypointerrestricted", code, "object")
		rec(typeof onvrdisplaypointerunrestricted, "onvrdisplaypointerunrestricted", code, "object")
		rec(typeof setImmediate, "setImmediate", code, "function")

		// gecko only
		code = 12
			// stable FF52+
		rec(typeof KeyEvent, "KeyEvent", code, "function")
		rec(typeof dump, "dump", code, "function")
		rec(typeof fullScreen, "fullScreen", code, "boolean")
		rec(typeof getDefaultComputedStyle, "getDefaultComputedStyle", code, "function")
		rec(typeof mozInnerScreenX, "mozInnerScreenX", code, "number")
		rec(typeof mozInnerScreenY, "mozInnerScreenY", code, "number")
		rec(typeof onmozfullscreenchange, "onmozfullscreenchange", code, "object")
		rec(typeof onmozfullscreenerror, "onmozfullscreenerror", code, "object")
		rec(typeof scrollByLines, "scrollByLines", code, "function")
		rec(typeof scrollByPages, "scrollByPages", code, "function")
		rec(typeof scrollMaxX, "scrollMaxX", code, "number")
		rec(typeof scrollMaxY, "scrollMaxY", code, "number")
		rec(typeof setResizable, "setResizable", code, "function")
		rec(typeof updateCommands, "updateCommands", code, "function")
			// deprecated
		rec(typeof mozPaintCount, "mozPaintCount", code, "number") // removed FF72
		rec(typeof onshow, "onshow", code, "object") // removed FF85 (+ not goanna or Waterfox Classic)
		rec(typeof ondevicelight, "ondevicelight", code, "object") // removed FF89
		rec(typeof ondeviceproximity, "ondeviceproximity", code, "object") // removed FF89
		rec(typeof onuserproximity, "onuserproximity", code, "object") // removed FF89
		rec(typeof content, "content", code, "object") // removed FF101
		rec(typeof sidebar, "sidebar", code, "object") // removed FF102
		rec(typeof onloadend, "onloadend", code, "object") // removed FF107 1574487
		rec(typeof InstallTrigger, "InstallTrigger", code, "object") // to-be-deprecated (+prefs)
		rec(typeof onabsolutedeviceorientation, "onabsolutedeviceorientation", code, "object") // removed FF110 1689631
		rec(typeof sizeToContent, "sizeToContent", code, "function") // removed nightly FF117+ 1832733 / 1600400

			// prefs
		rec(typeof onvrdisplayactivate, "onvrdisplayactivate", code, "object") // dom.vr.enabled (+ not in FF52)
		rec(typeof onvrdisplayconnect, "onvrdisplayconnect", code, "object")
		rec(typeof onvrdisplaydeactivate, "onvrdisplaydeactivate", code, "object") // (+ not in FF52)
		rec(typeof onvrdisplaydisconnect, "onvrdisplaydisconnect", code, "object")
		rec(typeof onvrdisplaypresentchange, "onvrdisplaypresentchange", code, "object")
		rec(typeof u2f, "u2f", code, "object") // security.webauth.u2f | pref removed in FF114

		// webkit only
		code = 14
		rec(typeof browser, "browser", code, "object")
		rec(typeof getMatchedCSSRules, "getMatchedCSSRules", code, "function")
		rec(typeof safari, "safari", code, "object")
		rec(typeof showModalDialog, "showModalDialog", code, "function")
		rec(typeof webkitCancelRequestAnimationFrame, "webkitCancelRequestAnimationFrame", code, "function")
		rec(typeof webkitConvertPointFromNodeToPage, "webkitConvertPointFromNodeToPage", code, "function")
		rec(typeof webkitConvertPointFromPageToNode, "webkitConvertPointFromPageToNode", code, "function")
		rec(typeof webkitIndexedDB, "webkitIndexedDB", code, "object")

		// blink + gecko (not seen in webkit)
		code = 50
		rec(typeof cancelIdleCallback, "cancelIdleCallback", code, "function")
		rec(typeof external, "external", code, "object")
		rec(typeof onbeforematch, "onbeforematch", code, "object") // FF139+ 1761043
		rec(typeof oncommand, "oncommand", code, "object") // FF144+
		rec(typeof ondeviceorientationabsolute, "ondeviceorientationabsolute", code, "object") // FF110+ 1689631
		rec(typeof ondragexit, "ondragexit", code, "object") // touch
		rec(typeof onorientationchange, "onorientationchange", code, "object") // mobile/tablet
		rec(typeof navigation, "navigation", code, "object") // // FF146 nightly 1979288
		rec(typeof onscrollend, "onscrollend", code, "object")
		rec(typeof ontouchcancel, "ontouchcancel", code, "object")
		rec(typeof ontouchend, "ontouchend", code, "object")
		rec(typeof ontouchmove, "ontouchmove", code, "object")
		rec(typeof ontouchstart, "ontouchstart", code, "object")
		rec(typeof orientation, "orientation", code, "number")
		rec(typeof requestIdleCallback, "requestIdleCallback", code, "function")
		rec(typeof scheduler, "scheduler", code, "object")
		rec(typeof trustedTypes, "trustedTypes", code, "object") // FF145 nightly 1955251 
		rec(typeof oncontextlost, "oncontextlost", code, "object")
		rec(typeof oncontextrestored, "oncontextrestored", code, "object")
		rec(typeof originAgentCluster, "originAgentCluster", code, "boolean") // FF138+ 1665474
		rec(typeof onpointerrawupdate, "onpointerrawupdate", code, "object") // FF140+ 1550462

		// blink + webkit (not seen in gecko)
		code = 52
		rec(typeof defaultstatus, "defaultstatus", code, "string")
		rec(typeof defaultStatus, "defaultStatus", code, "string")
		rec(typeof offscreenBuffering, "offscreenBuffering", code, "boolean") // edgeHTML
		rec(typeof onmousewheel, "onmousewheel", code, "object")
		rec(typeof onsearch, "onsearch", code, "object")
		rec(typeof styleMedia, "styleMedia", code, "object")
		rec(typeof webkitCancelAnimationFrame, "webkitCancelAnimationFrame", code, "function")
		rec(typeof webkitRequestAnimationFrame, "webkitRequestAnimationFrame", code, "function")

		// gecko + webkit (not seen in blink)
		code = 54
		rec(typeof onanimationcancel, "onanimationcancel", code, "object")
		rec(typeof oncopy, "oncopy", code, "object") // FF110+
		rec(typeof oncut, "oncut", code, "object") // FF110+
		rec(typeof ongamepadconnected, "ongamepadconnected", code, "object") // FF89+
		rec(typeof ongamepaddisconnected, "ongamepaddisconnected", code, "object") // FF89+
		rec(typeof onpaste, "onpaste", code, "object") // FF110+

		// I: IGNORE: confirmed common in blink, gecko, webkit
		code = 99
		rec(typeof addEventListener, "addEventListener", code, "function")
		rec(typeof alert, "alert", code, "function")
		rec(typeof applicationCache, "applicationCache", code, "object")
			// ^ gecko confirmed: pref-to-be-deprecated (appCache itself is deprecated: the API does nothing)
			// ^ ignore: appCache would have been in other older engine(s) releases
		rec(typeof atob, "atob", code, "function")
		rec(typeof blur, "blur", code, "function")
		rec(typeof btoa, "btoa", code, "function")
		rec(typeof caches, "caches", code, "object")
		rec(typeof cancelAnimationFrame, "cancelAnimationFrame", code, "function")
		rec(typeof captureEvents, "captureEvents", code, "function")
		rec(typeof clearInterval, "clearInterval", code, "function")
		rec(typeof clearTimeout, "clearTimeout", code, "function")
		rec(typeof clientInformation, "clientInformation", code, "object")
		rec(typeof close, "close", code, "function")
		rec(typeof closed, "closed", code, "boolean")
		rec(typeof confirm, "confirm", code, "function")
		rec(typeof cookieStore, "cookieStore", code, "object") // FF132 nightly 1918643
		rec(typeof createImageBitmap, "createImageBitmap", code, "function")
		rec(typeof crossOriginIsolated, "crossOriginIsolated", code, "boolean")
		rec(typeof crypto, "crypto", code, "object")
		rec(typeof customElements, "customElements", code, "object")
		rec(typeof devicePixelRatio, "devicePixelRatio", code, "number")
		rec(typeof dispatchEvent, "dispatchEvent", code, "function")
		rec(typeof document, "document", code, "object")
		rec(typeof fetch, "fetch", code, "function")
		rec(typeof find, "find", code, "function")
		rec(typeof focus, "focus", code, "function")
		rec(typeof frameElement, "frameElement", code, "object")
		rec(typeof frames, "frames", code, "object")
		rec(typeof getComputedStyle, "getComputedStyle", code, "function")
		rec(typeof getSelection, "getSelection", code, "function")
		rec(typeof history, "history", code, "object")
		rec(typeof indexedDB, "indexedDB", code, "object")
		rec(typeof innerHeight, "innerHeight", code, "number")
		rec(typeof innerWidth, "innerWidth", code, "number")
		rec(typeof isSecureContext, "isSecureContext", code, "boolean")
		rec(typeof KeyboardEvent, "KeyboardEvent", code, "function")
		rec(typeof KeyframeEffect, "KeyframeEffect", code, "function")
		rec(typeof length, "length", code, "number")
		rec(typeof localStorage, "localStorage", code, "object")
		rec(typeof location, "location", code, "object")
		rec(typeof locationbar, "locationbar", code, "object")
		rec(typeof matchMedia, "matchMedia", code, "function")
		rec(typeof menubar, "menubar", code, "object")
		rec(typeof moveBy, "moveBy", code, "function")
		rec(typeof moveTo, "moveTo", code, "function")
		rec(typeof name, "name", code, "string")
		rec(typeof navigator, "navigator", code, "object")
		rec(typeof onabort, "onabort", code, "object")
		rec(typeof onafterprint, "onafterprint", code, "object")
		rec(typeof onanimationend, "onanimationend", code, "object")
		rec(typeof onanimationiteration, "onanimationiteration", code, "object")
		rec(typeof onanimationstart, "onanimationstart", code, "object")
		rec(typeof onauxclick, "onauxclick", code, "object")
		rec(typeof onbeforeinput, "onbeforeinput", code, "object")
		rec(typeof onbeforeprint, "onbeforeprint", code, "object")
		rec(typeof onbeforetoggle, "onbeforetoggle", code, "object") // FF122+ 1867326 (and 1823359)
		rec(typeof onbeforeunload, "onbeforeunload", code, "object")
		rec(typeof onblur, "onblur", code, "object")
		rec(typeof oncancel, "oncancel", code, "object")
		rec(typeof oncanplay, "oncanplay", code, "object")
		rec(typeof oncanplaythrough, "oncanplaythrough", code, "object")
		rec(typeof onchange, "onchange", code, "object")
		rec(typeof onclick, "onclick", code, "object")
		rec(typeof onclose, "onclose", code, "object")
		rec(typeof oncontentvisibilityautostatechange, "oncontentvisibilityautostatechange", code, "object")
		rec(typeof oncontextmenu, "oncontextmenu", code, "object")
		rec(typeof oncuechange, "oncuechange", code, "object")
		rec(typeof ondblclick, "ondblclick", code, "object")
		rec(typeof ondevicemotion, "ondevicemotion", code, "object")
		rec(typeof ondeviceorientation, "ondeviceorientation", code, "object")
		rec(typeof ondrag, "ondrag", code, "object")
		rec(typeof ondragend, "ondragend", code, "object")
		rec(typeof ondragenter, "ondragenter", code, "object")
		rec(typeof ondragleave, "ondragleave", code, "object")
		rec(typeof ondragover, "ondragover", code, "object")
		rec(typeof ondragstart, "ondragstart", code, "object")
		rec(typeof ondrop, "ondrop", code, "object")
		rec(typeof ondurationchange, "ondurationchange", code, "object")
		rec(typeof onemptied, "onemptied", code, "object")
		rec(typeof onended, "onended", code, "object")
		rec(typeof onerror, "onerror", code, "object")
		rec(typeof onfocus, "onfocus", code, "object")
		rec(typeof onformdata, "onformdata", code, "object")
		rec(typeof ongotpointercapture, "ongotpointercapture", code, "object")
		rec(typeof onhashchange, "onhashchange", code, "object")
		rec(typeof oninput, "oninput", code, "object")
		rec(typeof oninvalid, "oninvalid", code, "object")
		rec(typeof onkeydown, "onkeydown", code, "object")
		rec(typeof onkeypress, "onkeypress", code, "object")
		rec(typeof onkeyup, "onkeyup", code, "object")
		rec(typeof onlanguagechange, "onlanguagechange", code, "object")
		rec(typeof onload, "onload", code, "object")
		rec(typeof onloadeddata, "onloadeddata", code, "object")
		rec(typeof onloadedmetadata, "onloadedmetadata", code, "object")
		rec(typeof onloadstart, "onloadstart", code, "object")
		rec(typeof onlostpointercapture, "onlostpointercapture", code, "object")
		rec(typeof onmessage, "onmessage", code, "object")
		rec(typeof onmessageerror, "onmessageerror", code, "object")
		rec(typeof onmousedown, "onmousedown", code, "object")
		rec(typeof onmouseenter, "onmouseenter", code, "object")
		rec(typeof onmouseleave, "onmouseleave", code, "object")
		rec(typeof onmousemove, "onmousemove", code, "object")
		rec(typeof onmouseout, "onmouseout", code, "object")
		rec(typeof onmouseover, "onmouseover", code, "object")
		rec(typeof onmouseup, "onmouseup", code, "object")
		rec(typeof onoffline, "onoffline", code, "object")
		rec(typeof ononline, "ononline", code, "object")
		rec(typeof onpagehide, "onpagehide", code, "object")
		rec(typeof onpageshow, "onpageshow", code, "object")
		rec(typeof onpause, "onpause", code, "object")
		rec(typeof onplay, "onplay", code, "object")
		rec(typeof onplaying, "onplaying", code, "object")
		rec(typeof onpointercancel, "onpointercancel", code, "object")
		rec(typeof onpointerdown, "onpointerdown", code, "object")
		rec(typeof onpointerenter, "onpointerenter", code, "object")
		rec(typeof onpointerleave, "onpointerleave", code, "object")
		rec(typeof onpointermove, "onpointermove", code, "object")
		rec(typeof onpointerout, "onpointerout", code, "object")
		rec(typeof onpointerover, "onpointerover", code, "object")
		rec(typeof onpointerup, "onpointerup", code, "object")
		rec(typeof onpopstate, "onpopstate", code, "object")
		rec(typeof onprogress, "onprogress", code, "object")
		rec(typeof onratechange, "onratechange", code, "object")
		rec(typeof onrejectionhandled, "onrejectionhandled", code, "object")
		rec(typeof onreset, "onreset", code, "object")
		rec(typeof onresize, "onresize", code, "object")
		rec(typeof onscroll, "onscroll", code, "object")
		rec(typeof onsecuritypolicyviolation, "onsecuritypolicyviolation", code, "object")
		rec(typeof onseeked, "onseeked", code, "object")
		rec(typeof onseeking, "onseeking", code, "object")
		rec(typeof onselect, "onselect", code, "object")
		rec(typeof onselectionchange, "onselectionchange", code, "object")
		rec(typeof onselectstart, "onselectstart", code, "object")
		rec(typeof onslotchange, "onslotchange", code, "object")
		rec(typeof onstalled, "onstalled", code, "object")
		rec(typeof onstorage, "onstorage", code, "object")
		rec(typeof onsubmit, "onsubmit", code, "object")
		rec(typeof onsuspend, "onsuspend", code, "object")
		rec(typeof ontimeupdate, "ontimeupdate", code, "object")
		rec(typeof ontoggle, "ontoggle", code, "object")
		rec(typeof ontransitioncancel, "ontransitioncancel", code, "object")
		rec(typeof ontransitionend, "ontransitionend", code, "object")
		rec(typeof ontransitionrun, "ontransitionrun", code, "object")
		rec(typeof ontransitionstart, "ontransitionstart", code, "object")
		rec(typeof onunhandledrejection, "onunhandledrejection", code, "object")
		rec(typeof onunload, "onunload", code, "object")
		rec(typeof onvolumechange, "onvolumechange", code, "object")
		rec(typeof onwaiting, "onwaiting", code, "object")
		rec(typeof onwebkitanimationend, "onwebkitanimationend", code, "object")
		rec(typeof onwebkitanimationiteration, "onwebkitanimationiteration", code, "object")
		rec(typeof onwebkitanimationstart, "onwebkitanimationstart", code, "object")
		rec(typeof onwebkittransitionend, "onwebkittransitionend", code, "object")
		rec(typeof onwheel, "onwheel", code, "object")
		rec(typeof open, "open", code, "function")
		rec(typeof opener, "opener", code, "object")
		rec(typeof origin, "origin", code, "string")
		rec(typeof outerHeight, "outerHeight", code, "number")
		rec(typeof outerWidth, "outerWidth", code, "number")
		rec(typeof pageXOffset, "pageXOffset", code, "number")
		rec(typeof pageYOffset, "pageYOffset", code, "number")
		rec(typeof parent, "parent", code, "object")
		rec(typeof performance, "performance", code, "object")
		rec(typeof personalbar, "personalbar", code, "object")
		rec(typeof postMessage, "postMessage", code, "function")
		rec(typeof print, "print", code, "function")
		rec(typeof prompt, "prompt", code, "function")
		rec(typeof queueMicrotask, "queueMicrotask", code, "function")
		rec(typeof releaseEvents, "releaseEvents", code, "function")
		rec(typeof removeEventListener, "removeEventListener", code, "function")
		rec(typeof reportError, "reportError", code, "function")
		rec(typeof requestAnimationFrame, "requestAnimationFrame", code, "function")
		rec(typeof resizeBy, "resizeBy", code, "function")
		rec(typeof resizeTo, "resizeTo", code, "function")
		rec(typeof screen, "screen", code, "object")
		rec(typeof screenLeft, "screenLeft", code, "number")
		rec(typeof screenTop, "screenTop", code, "number")
		rec(typeof screenX, "screenX", code, "number")
		rec(typeof screenY, "screenY", code, "number")
		rec(typeof scroll, "scroll", code, "function")
		rec(typeof scrollBy, "scrollBy", code, "function")
		rec(typeof scrollTo, "scrollTo", code, "function")
		rec(typeof scrollX, "scrollX", code, "number")
		rec(typeof scrollY, "scrollY", code, "number")
		rec(typeof scrollbars, "scrollbars", code, "object")
		rec(typeof self, "self", code, "object")
		rec(typeof sessionStorage, "sessionStorage", code, "object")
		rec(typeof setInterval, "setInterval", code, "function")
		rec(typeof setTimeout, "setTimeout", code, "function")
		rec(typeof speechSynthesis, "speechSynthesis", code, "object")
		rec(typeof status, "status", code, "string")
		rec(typeof statusbar, "statusbar", code, "object")
		rec(typeof stop, "stop", code, "function")
		rec(typeof structuredClone, "structuredClone", code, "function")
		rec(typeof toolbar, "toolbar", code, "object")
		rec(typeof top, "top", code, "object")
		rec(typeof visualViewport, "visualViewport", code, "object")
		rec(typeof window, "window", code, "object")

		// LEVEL 2
		// I don't think we need bother with level 2 for a mini isEngine
		/*
		if ("undefined" !== typeof caches) {
			rec(typeof caches.delete, "caches.delete")
			rec(typeof caches.has, "caches.has")
			rec(typeof caches.keys, "caches.keys")
			rec(typeof caches.match, "caches.match")
			rec(typeof caches.open, "caches.open")
		}
		*/
		output()
	} catch(e) {
		console.error(e.name, e.message)
	}
}

function scrape() {
	domresult.innerHTML = "<br>... running"

	aNew = []
	// delay so user sees changes
	setTimeout(function() {
		tstart = performance.now()
		let result = collectProps().window

		// cleanup
		delete result.event // caused by calling event in the scrape function
		delete result.dom // just in case
		delete result.collectProps
		delete result.compare
		delete result.copyclip
		delete result.get_engineItem
		delete result.get_engineProp
		delete result.get_miniEngine
		delete result.json_highlight
		delete result.json_stringify
		delete result.logConsole
		delete result.mini
		delete result.output
		delete result.rec
		delete result.rerun
		delete result.reset
		delete result.run
		delete result.scrape
		//console.log(result)

		// sanitize localStorage
		let aDelLS = []
		let sessionGood = ["clear","getItem","key","length","removeItem","setItem"]
		try {
			for (const ls of Object.keys(result["localStorage"]["properties"])) {
				if (!sessionGood.includes(ls)) {
					delete result["localStorage"]["properties"][ls]
					aDelSL.push(ls)
				}
			}
		} catch(e) {}
		// sanitize sessionStorage
		let aDelSS = []
		try {
			for (const ss of Object.keys(result["sessionStorage"]["properties"])) {
				if (!sessionGood.includes(ss)) {
					delete result["sessionStorage"]["properties"][ss]
					aDelSS.push(ss)
				}
			}
		} catch(e) {}
		// silently record sanitized
		let strDel = ""
		if (aDelSS.length || aDelLS.length) {
			strDel = sb +"REMOVED: "+ sc +"random state variables<br><br>"
				+ (aDelLS.length ? "localStorage  : " + aDelLS.join(", ") +"<br>" : "")
				+ (aDelSS.length ? "sessionStorage: " + aDelSS.join(", ") +"<br>" : "")
				+"<br>"
		}

		// hash it for easier compare
		let hash = mini(result)
		domperf.innerHTML = Math.round((performance.now() - tstart)) +" ms"

		// check if any first level items are not in aList
		let strNew = ""
		if (aList.length) {
			aNew = Object.keys(result)
			aNew = aNew.filter(x => !aList.includes(x))
			if (aNew.length) {
				strNew = sb +"NEW:"+ sc + "<br><br>" + aNew.join(", ") + sc +"<br><br>"
			}
		}
		domresult.innerHTML = strNew + strDel + s3 + "HASH: "+ sc + hash +"<br><br>"
			+ json_highlight(result)

	}, 100)
}

function compare() {
	// examples: just paste in scrape results
	let sBlink = {"all3": [], "blink": [], "blink-gecko": [], "blink-webkit": []}
	let sGecko = {"all3": [], "gecko": [], "blink-gecko": [], "gecko-webkit": []}
	let sWebkit = {"all3": [], "webkit": [], "blink-webkit": [], "gecko-webkit": []}

	let aBlink = Object.keys(sBlink)
	let aGecko = Object.keys(sGecko)
	let aWebkit = Object.keys(sWebkit)

	let commonBG = aBlink.filter(x => aGecko.includes(x))
	let commonBW = aBlink.filter(x => aWebkit.includes(x))
	let commonGW = aGecko.filter(x => aWebkit.includes(x))
	let common = commonBG.concat(commonBW)
	common = common.concat(commonGW)
	common = common.filter(function(item, position) {return common.indexOf(item) === position})
	common.sort()
	console.log("NOT UNIQUE: "+ common.length +"\n" + common.join("\n"))

	let common3 = commonBG
	common3 = commonBG.filter(x => aWebkit.includes(x))
	common3 = common3.filter(function(item, position) {return common3.indexOf(item) === position})
	common3.sort()
	console.log("COMMON IN ALL THREE: "+ common3.length +"\n" + common3.join("\n"))

	let BGonly = commonBG.filter(x => !common3.includes(x))
	BGonly.sort()
	console.log("COMMON IN BLINK + GECKO ONLY: "+ BGonly.length +"\n" + BGonly.join("\n"))

	let BWonly = commonBW.filter(x => !common3.includes(x))
	BWonly.sort()
	console.log("COMMON IN BLINK + WEBKIT ONLY: "+ BWonly.length +"\n" + BWonly.join("\n"))

	let GWonly = commonGW.filter(x => !common3.includes(x))
	GWonly.sort()
	console.log("COMMON IN GECKO + WEBKIT ONLY: "+ GWonly.length +"\n" + GWonly.join("\n"))
}
//compare()

function get_miniEngine() {
	let tstart = performance.now()
	let oEngines = {
		"blink": [
			"number" === typeof TEMPORARY,
			"number" === typeof PERSISTENT,
			"object" === typeof onappinstalled,
			"object" === typeof onbeforeinstallprompt,
			//"object" === typeof onpointerrawupdate,
			//"object" === typeof onsearch,
			//"boolean" === typeof originAgentCluster,
			"object" === typeof trustedTypes,
			"function" === typeof webkitResolveLocalFileSystemURL,
		],
		"webkit": [
			"object" === typeof browser,
			//"function" === typeof getMatchedCSSRules,
			"object" === typeof safari,
			//"function" === typeof showModalDialog,
			"function" === typeof webkitConvertPointFromNodeToPage,
			"function" === typeof webkitCancelRequestAnimationFrame,
			"object" === typeof webkitIndexedDB,
		],
		"gecko": [
			"function" === typeof dump,
			"boolean" === typeof fullScreen,
			"number" === typeof mozInnerScreenX,
			"function" === typeof scrollByLines,
			"number" === typeof scrollMaxY,
			"function" === typeof setResizable,
			//"function" === typeof sizeToContent, // removed nightly FF117+ 1832733 / 1600400
			"function" === typeof updateCommands,
		],
		"edgeHTML": [
			"function" === typeof clearImmediate,
			"function" === typeof msWriteProfilerMark,
			"object" === typeof oncompassneedscalibration,
			"object" === typeof onmsgesturechange,
			"object" === typeof onmsinertiastart,
			"object" === typeof onreadystatechange,
			//"object" === typeof onvrdisplayfocus,
			"function" === typeof setImmediate,
		]
	}
	// array engine matches, so subsequent results doesn't override prev
	let aEngine = []
	for (const engine of Object.keys(oEngines).sort()) {
		let sumE = oEngines[engine].reduce((prev, current) => prev + current, 0)
		if (sumE > (oEngines[engine].length/2)) {aEngine.push(engine)}
	}
	if (aEngine.length == 1) {isEngine = aEngine[0]} // valid one result
	// perf
	let tend = performance.now()
	// re-tidy vars
	if (isEngine == "gecko") {
		// check for PM28+ : fails 53
		if ("function" !== typeof CSSMozDocumentRule) {
			isEngine = "goanna"
		}
	}
	// build a pretty display
	let displayAll = []
	for (const engine of Object.keys(oEngines).sort()) {
		let displayE = []
		oEngines[engine].forEach(function(check) {
			displayE.push(check ? green_tick : red_cross)
		})
		displayAll.push(displayE.join(""))
	}
	isEnginePretty = Math.round(tend-tstart) +" ms |"+ displayAll.join(" |")
		+ " | " + (isEngine == "" ? "UNKNOWN" : isEngine.toUpperCase())
}

let isEnginePretty = ""
let isEngine = ""
Promise.all([
	get_miniEngine()
]).then(function(){
	reset()
	run()
})

</script>
</body>
</html>
