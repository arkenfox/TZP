<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=800">
	<title>muberingsystem</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<style>
		table {width: 780px;}
		hr {color: var(--test4);}
	</style>
</head>

<body>
	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html#region">return to TZP index</a></td></tr>
	</table>

	<table id="tb4">
		<col width="33%"><col width="67%">
		<thead><tr><th colspan="2">
			<div class="nav-title">numberingsystem
			<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">locales grouped by DateTimeFormat + RelativeTimeFormat > resolvedOptions > numberingSystem</span>
		</td></tr>
		<tr>
			<td class="mono spaces" id="legend" style="text-align: left; vertical-align: top; color: #b3b3b3; font-size: 11px"></td>
			<td class="mono" style="text-align: left; vertical-align: top;">
				<span id="bdtf" class="btn4 btnfirst" onClick="run('dtf')">[ DTF ]</span>
				<span id="brtf" class="btn4 btn" onClick="run('rtf')">[ RTF ]</span>
			<br><br><hr><br>
				<span id ="results"></span>
			</td></tr>
	</table>
	<br>

<script>
'use strict';

var list = gLocales,
	aLegendDTF = [],
	aLocalesDTF = [],
	aLegendRTF = [],
	aLocalesRTF = []

let isSupported = false

s4 = s4.trim()
s12 = s12.trim()
s14 = s14.trim()
s16 = s16.trim()
sg = sg.trim()
s99 = s99.trim()

function legend(method = "dtf") {
	// bail if RTF not supported
	if (method == "rtf" && !isSupported) {
		return
	}

	let proceed = false
	if (method == "dtf") {
		if (aLegendDTF.length == 0) {proceed = true}
	} else {
		if (aLegendRTF.length == 0) {proceed = true}
	}

	// build once
	if (proceed) {
		list.sort()
		for (let i = 0 ; i < list.length; i++) {
			let str = list[i].toLowerCase()
			let code = str.split(",")[0].trim()
			let name = str.split(",")[1].trim()
			let go = true
			if (method == "dtf") {
				go = Intl.DateTimeFormat.supportedLocalesOf([code]).length > 0
			} else {
				go = Intl.RelativeTimeFormat.supportedLocalesOf([code]).length > 0
			}
			if (go) {
				if (method == "dtf") {
					aLocalesDTF.push(code)
				} else {
					aLocalesRTF.push(code)
				}
				let isSplit = (name.includes("(") && (name.length + code.length) > 32)
				if (name.includes("(")) {
					let name0 = name.split("(")[0].trim()
					let name1 = name.substring(
						name.indexOf("(") + 1, 
						name.lastIndexOf(")")
					)
					name1 = s99 +"("+ name1 + ")"+ sc
					if (isSplit) {
						name = name0 +"<br>"+ " ".repeat(4) + name1
					} else {
						name = name0 +" "+ name1
					}
				}
				if (method == "dtf") {
					aLegendDTF.push(code.padStart(7) +": "+ name)
				} else {
					aLegendRTF.push(code.padStart(7) +": "+ name)
				}
			}
		}
	}
	// output
	let aDisplay = (method == "dtf" ? aLegendDTF : aLegendRTF)
	let	header = s4 + method.toUpperCase() +" LEGEND ["+ aDisplay.length +" from supported]"+ sc +"<br><br>"
	dom.legend.innerHTML = header + aDisplay.join("<br>")
}

function run_main(method) {
	let t0 = performance.now()
	let oData = {}, oTempData = {}
	let spacer = "<br><br>"

	try {
		let array = (method == "dtf" ? aLocalesDTF : aLocalesRTF)
		// test
		array.forEach(function(code) {
			let value = Intl.DateTimeFormat(code).resolvedOptions().numberingSystem
			if (oTempData[value] == undefined) {
				oTempData[value] = [code]
			} else {
				oTempData[value].push(code)
			}
		})
		// handle empty
		if (Object.keys(oTempData).length == 0) {
			dom.results.innerHTML = "nothing"
			return
		}

		// order object
		for (const n of Object.keys(oTempData).sort()) {
			oData[n] = oTempData[n]
		}
		let localeGroups = [], displaylist = []
		for (const k of Object.keys(oData)) {
			localeGroups.push(oData[k])
			let localeCount = oData[k].length
			displaylist.push(
				s12 + k + sc + s4 + " ["+ localeCount +"]"+ sc
				+ "<ul><li>" + oData[k].join(", ") +"</li></ul>"
			)
		}
		// hashes
		let resultsHash = mini(oData)
		localeGroups.sort()
		let localesHash = mini(localeGroups)

		/*
		console.log(localesHash)
		console.log(localeGroups)
		console.log(resultsHash)
		console.log(oData)
		console.log(oTempData)
		//*/
		// display
		let display = s4 + method.toUpperCase() +": [" + localeGroups.length + sc +" from "+ s4 + array.length +"]"+ sc
			+ spacer + s16 +"results: "+ sc + resultsHash +"<br>"
			+ s12 +"locales: "+ sc + localesHash + spacer
		dom.results.innerHTML = display + "<br>" + displaylist.join("<br>")
		// perf
		dom.perf.innerHTML = Math.round(performance.now() - t0) +" ms"
	} catch(e) {
		dom.results.innerHTML = s4 + e.name +": "+ sc + e.message
	}
}

function run(method) {
	//reset
	setBtn(method)
	dom.perf = ""
	dom.results = ""
	if (method == "rtf") {
		try {
			let test = new Intl.RelativeTimeFormat().resolvedOptions().numberingSystem
		} catch(e) {
			dom.results.innerHTML = "<br>"+ s4 + e.name +": "+ sc + e.message
			return
		}
	}
	legend(method)
	// delay so users see change and allow paint
	setTimeout(function() {
		run_main(method)
	}, 20)
}

function setBtn(method) {
	// reset btns
	let items = document.getElementsByClassName("btn8")
	for (let i=0; i < items.length; i++) {
		items[i].classList.add("btn4")
		items[i].classList.remove("btn8")
	}
	// set btn
	let el = document.getElementById("b"+ method)
	el.classList.add("btn8")
	el.classList.remove("btn4")
}

Promise.all([
	get_globals()
]).then(function(){
	// RTF support
	try {
		let test = new Intl.RelativeTimeFormat().resolvedOptions().numberingSystem
		isSupported = true
	} catch(e) {
		isSupported = false
	}
	// add additional locales to core locales for this test
	let aListExtra = [
		"ff-adlm,fulah (adlam)", // adlam
	]
	list = list.concat(aListExtra)
	list = list.filter(function(item, position) {return list.indexOf(item) === position})
	run("dtf")
})

</script>
</body>
</html>
