<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=500">
	<title>recursion</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<style>
		table {width: 480px;}
		span.indent {
			display:inline-block;
			margin-left:20px;
			margin-bottom: 10px;
		}
		.mono {font-family: monospace, "Courier New"; font-size: 12px;}
		.grey {color: grey;}
	</style>
</head>

<body>
	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb18">
		<col width="40%"><col width="60%">
		<thead><tr><th colspan="2">
			<div class="nav-title">recursion | stack length
				<div class="nav-up"><span class="c perf" id="perf"></span></div>
				<div class="nav-down"><span class="c perf" id="type"></span></div>
			</div>
		</th></tr></thead>
		<tr>
			<td><span class="btnfirst btn" onClick="run('doc')">[ run ]</span> DOCUMENT</td>
			<td class="mono">
				<span class='s14'>RUN 1:</span><br><span class='indent grey'>level: <span id="doc1"></span><br>stack: <span id="doc2"></span></span><br>
				<span class='s14'>RUN 2:</span><br><span class='indent grey'>level: <span id="doc3"></span><br>stack: <span id="doc4"></span></span>
			</td>
		</tr>
		<tr>
			<td><span class="btnfirst btn" onClick="run('worker')">[ run ]</span> WORKER</td>
			<td class="mono">
				<span class='s14'>RUN 1:</span><br><span class='indent grey'>level: <span id="worker1"></span><br>stack: <span id="worker2"></span></span><br>
				<span class='s14'>RUN 2:</span><br><span class='indent grey'>level: <span id="worker3"></span><br>stack: <span id="worker4"></span></span>
			</td>
		</tr>
		<tr>
			<td><span class="btnfirst btn" onClick="run('iframe')">[ run ]</span> IFRAME</td>
			<td><iframe id="targetiframe" width="150" style="border: none;"></iframe></td>
		</tr>

	</table>
	<br>

<script>
'use strict';

const get_isRecursion_doc = () => new Promise(resolve => {
	let t0 = performance.now()
	try {
		let level = 0
		function recurse() {level++; recurse()}
		try {
			recurse()
		} catch(e) {
			document.getElementById("doc1").innerHTML = level
			document.getElementById("doc2").innerHTML = e.stack.toString().length
		}
		level = 0
		try {
			recurse()
		} catch(e) {
			// 2nd test is more accurate/stable
			document.getElementById("doc3").innerHTML = level
			document.getElementById("doc4").innerHTML = e.stack.toString().length
			document.getElementById("perf").innerHTML = Math.round(performance.now() - t0) +"ms"
			return resolve()
		}
	} catch(e) {
		console.error(e)
		document.getElementById("doc1").innerHTML = e.name
		return resolve()
	}
})

function get_isRecursion_iframe() {
	try {
		let element = document.getElementById("targetiframe")
		element.src = "recursion_iframe.html"
	} catch(e) {
		console.log(e+"")
	}
}

const get_isRecursion_worker = () => new Promise(resolve => {
	const METRIC = "isRecursion"
	try {
		let worker = new Worker("recursion_worker.js")
		worker.addEventListener("message", function(msg) {
			for (const k of Object.keys(msg.data)) {
				document.getElementById(k).innerHTML = msg.data[k]
			}
			worker.terminate
		}, false)
		worker.postMessage("")
	} catch(e) {
		console.error(e)
		document.getElementById("worker1").innerHTML = e.name
	}
})

function run(type) {

	document.getElementById("type").innerHTML = (type == "doc" ? "document" : type)
	document.getElementById("perf").innerHTML = ""
	if (type == "iframe") {
		let element = document.getElementById("targetiframe")
		element.src = ""
	} else {
		for (let i=1; i < 5; i++) {
			document.getElementById(type+i).innerHTML = ""
		}
	}
	// delay
	setTimeout(function() {
		if (type == "doc") {
			get_isRecursion_doc()
		} else if (type == "worker") {
			get_isRecursion_worker()
		} else if (type == "iframe") {
			get_isRecursion_iframe()
		}
	}, 100)

}

</script>
</body>
</html>
