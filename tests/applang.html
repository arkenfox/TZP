<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=500">
	<title>app language</title>
  <link rel="stylesheet" type="text/css" href="testindex.css">
  <script src="testglobals.js"></script>
  <script src="testgeneric.js"></script>
	<style>
		table {width: 97%; min-width: 480px; max-width: 680px}
		hr {color: var(--test4);}
		.floatright {
			float: right;
			display: inline;
			width: 250px;
			color: var(--test0);
		}
		.flex-item {
			margin: 0px 0px 10px 0px;
		}
		#edetails {display: inline;}
	</style>
</head>

<body>
	<!-- offscreen -->
	<div class="offscreen">
		<div>
			<!-- applang-image.png can't be hidden otherwise "Scaled..." is not in the title -->
			<iframe id="iframe-mediaInvalid" width="100" height="30" src="applang-invalid.png"></iframe>
			<iframe id="iframe-mediaScaled" width="100" height="30" src="applang-image.png"></iframe>
			<iframe id="iframe-mediaUnsupported" width="100" height="30" src="applang-unsupported.png"></iframe>
			<div><span id="dfsize"></span></div>
			<div id="sysFont"></div>
		</div>
	</div>
	<div class="hidden">
		<div>
			<input type="text" required id="widgettext">
			<input type="checkbox" required id="widgetcheckbox">
			<input type="date" id="widgetdatetime" value="2024-01-01" max="2023-12-31">
			<input type="date" id="widgetdatetimeunder" value="2022-01-01" min="2023-12-31">
			<input type="email" id="widgetemail" value="a">
			<input type="file" required id="widgetfile">
			<input type="number" required id="widgetnumber">
			<input type="number" id="widgetmax" max="1974.3" value="2000">
			<input type="number" id="widgetmin" min="8026.5" value="1">
			<input type="number" id="widgetstep" min="1.2345" step="1005.5545" value="2">
			<input type="radio" required name="radiogroup" id="widgetradio">
			<select required id="widgetselect"><option></option></select>
			<input type="url" id="widgeturl" value="a">
			<input type="tel" id="widgettel" pattern="[0-9]{1}" value="a">
			<!-- the rest not covered by the visually displayed ones -->
			<input type="hidden" id="ehidden">
			<input type="image" id="eimage">
			<input type="month" id="emonth">
			<input type="password" id="epassword">
			<input type="range" id="erange">
			<input type="search" id="esearch">
			<textarea id="etextarea"></textarea>
			<input type="week" id="eweek">
		</div>
	</div>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html#region">return to TZP index</a></td></tr>
	</table>

	<!-- app lang -->
	<table id="tb4">
		<col width="25%"></a><col width="75%">
		<thead><tr><th colspan="2">
			<div class="nav-title">application language
			<div class="nav-up"><span class="c perf" id="locale"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="btn-left btn4 btn" onClick="run()">[ run ]</span>
		</td></tr>
		<tr><td colspan="2"><hr><br></td></tr>

		<tr><td colspan="2" style="text-align: left;">
			<div class="floatright">
				<div class="flex-item">
<input id="ebutton" type="button"> &nbsp;
<input id="ecolor" type="color"> &nbsp;
<input id="echeckbox" type="checkbox"> &nbsp;
<input id="eradio" type="radio">
				</div>
				<div class="flex-item"><input id="edate" type="date"></div>
				<div class="flex-item"><input id="edatetime-local" type="datetime-local"></div>
				<div class="flex-item"><details id="edetails"></details></div>
				<div class="flex-item"><input id="edirectory" webkitdirectory type="file"></div>
				<div class="flex-item"><input id="efile" type="file"></div>
				<div class="flex-item"><input id="efiles" multiple="" type="file"></div>
				<div class="flex-item"><input id="enumber" type="number" min="6" step="2"></div>
				<div class="flex-item"><input id="ereset" type="reset"> &nbsp; <select id="eselect"><option></option></select></div>
				<div class="flex-item">
					<select multiple="" id="eselectempty"><option id="optempty"></option></select> &nbsp;
					<select multiple="" id="eselectspaces"><option id="optspaces"> &nbsp;  &nbsp;  &nbsp; </option></select> &nbsp;
					<select multiple="" id="eselectstring"><option id="optstring">Mōá?-&#xffff;</option></select> &nbsp;
				</div>
				<div class="flex-item"><input id="esubmit" type="submit"></div>
				<div class="flex-item"><input id="etime" type="time"></div><br>
			</div>
			<div>ELEMENTS &nbsp;
				<a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/HtmlForm.properties' target='blank'>searchfox HtmlForm</a>
				<br><br><span class="c mono spaces no_color" id="elements"></span><span>
			</div>
		</td></tr>

		<tr><td colspan="2" style="text-align: left;">
			<div>FONTS &nbsp; <span class="c mono no_color" id="fontshash"></span><br>
				<br><span class="c mono spaces no_color" id="fonts"></span><span><br>
			</div>
		</td></tr>

		<tr><td colspan="2" style="text-align: left;">
			<div>NUMERIC INPUT &nbsp; <span class="c mono no_color" id="numericinputhash"></span><br>
				<br><span class="c mono spaces no_color" id="numeric_input"></span><span><br>
			</div>
		</td></tr>

		<tr><td colspan="2" style="text-align: left;">
			<div>MEDIA MESSAGES <sup>1</sup> &nbsp; 
				<a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/MediaDocument.properties' target='blank'>searchfox MediaDocument</a>
				<br><br><span class="c mono spaces no_color" id="media_messages"></span><span>
			</div>
			<br>
			<div>VALIDATION MESSAGES <sup>1</sup> &nbsp; 
				<a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/dom/dom.properties' target='blank'>searchfox dom.properties</a>
				<br><br><span class="c mono spaces no_color" id="validation_messages"></span>
			</div>
			<br>
			<div>XML ERRORS <sup>1</sup> &nbsp; 
			<a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/xmlparser.properties' target='blank'>searchfox xmlparser</a>
			<br><br><span class="c mono spaces no_color" id="xml_errors"></span>
			</div>
		</td></tr>

		<!--credits-->
		<tr><td colspan="2"></td></tr>
		<tr><td colspan="2"><span class="no_color">code based on work by </span>
			<!--DTD
				https://acatarineu.github.io/fp/locale.html"
				https://acatarineu.github.io/fp/locale_nullprincipal.html
			-->
			<a target="_blank" class="blue" href="https://trac.torproject.org/projects/tor/ticket/30683">z3t on HackerOne</a> <sup>1</sup>
			</td>
		</tr>

		</table>
	<br>

<script>
'use strict';

let isSystemFont = [],
	baseFonts = [],
	fntString = "Mōá?-&#xffff;"

function get_dtd1() {
	// FF70+ https://bugzilla.mozilla.org/show_bug.cgi?id=467035
	// if spoofing english we would expect "Problem loading page"
	let isDone = false
	setTimeout(() => output("timed out"), 600)
	function output(value) {
		if (!isDone) {
			isDone = true
			dom.dtd1 = value
			return
		}
	}
	function next() {
		try {
			let iframe = dom.iframedtd1
			iframe.src="applang.xml"
			iframe.addEventListener('load', () => {
				try {
					let res = iframe.contentDocument.getElementById("DTD1").innerText
					output(res)
				} catch(e) {
					output(e+"")
				}
			})
		} catch(e) {
			output(e+"")
		}
	}
}

function get_dtd2() {
	// dtd nullprinciple
	// FF70+ https://bugzilla.mozilla.org/show_bug.cgi?id=467035
	// if spoofing english we would expect "Problem loading page"

	// on my FF i get "[object Object]" Object is { msg: "getUrlParent" }
	// on test suites I get timed out

	let dtd2
	function output(value) {
		//console.log(dtd2)
		dom.dtd2.innerHTML = value
		return
	}
	// set source
	let iframe = dom.iframedtd2
	// ? chrome://global/locale/netError.dtd
	iframe.src="data:application/xml;charset=utf-8,%3C%21DOCTYPE%20html%20SYSTEM%20%22chrome%3A%2F%2Fglobal%2Flocale%2FnetError.dtd%22%3E%3Chtml%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%3E%3Chead%3E%3Cmeta%20charset%3D%22utf-8%22%2F%3E%0D%0A%20%20%3C%2Fhead%3E%0D%0A%20%20%3Cbody%3E%3Cspan%20id%3D%22text-container%22%3E%26loadError.label%3B%3C%2Fspan%3E%0D%0A%20%20%3Cscript%3E%0D%0A%20%20window.addEventListener%28%27message%27%2C%20%28e%29%20%3D%3E%20%7B%0D%0A%20%20%20%20e.source.postMessage%28document.getElementById%28%27text-container%27%29.innerText%2C%20%27%2A%27%29%3B%0D%0A%20%20%7D%29%3B%0D%0A%20%20%3C%2Fscript%3E%0D%0A%20%20%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E";
	iframe.addEventListener('load', () => {
		window.addEventListener('message', ({ data }) => dtd2 = data)
		iframe.contentWindow.postMessage('foo', '*')
	})

	// keep checking dtd2 not undefined, but stop after x tries
	let counter = 0
	function check_dtd2() {
		//console.log(counter, "dtd2 is", dtd2)
		if (counter < 30) {
			if (dtd2 !== undefined) {
				clearInterval(checking)
				output(dtd2 +"")
			}
		} else {
			clearInterval(checking)
			output("timed out")
		}
		counter++
	}
	let checking = setInterval(check_dtd2, 50)
}

const get_default_proportional = () => new Promise(resolve => {
	const METRIC = "default_proportional"
	let res
	try {
		res = window.getComputedStyle(document.body,null).getPropertyValue("font-family")
	} catch(e) {
		res = e+""
	}
	return resolve([METRIC, res])
})

const get_default_sizes = () => new Promise(resolve => {
	const METRIC = "default_sizes"
	try {
		let oRes = {}
		let el = dom.dfsize
		let styles = [ // sorted
			'cursive','emoji','fangsong','fantasy','math','monospace','none','sans-serif',
			'serif','system-ui','ui-monospace','ui-rounded','ui-sans-serif','ui-serif',
		]
		styles.forEach(function(style) {
			el.style.fontFamily = style
			let size = getComputedStyle(el).getPropertyValue("font-size")
			if (oRes[size] == undefined) {oRes[size] = []}
			oRes[size].push(style)
		})
		let fpObj = {}
		for (const k of Object.keys(oRes).sort()) {fpObj[k] = oRes[k]} // sort obj
		return resolve([METRIC, fpObj])
	} catch(e) {
		return resolve([METRIC, e+""])
	}
})

function get_elements() {
	// ui.useOverlayScrollbars: 0=on, 1=off
	// windows 11 on -> off (en-US)
		//  empty 29 -> 12 = -17
		// spaces 49 -> 32 = -17
		// string 78 -> 61 = -17
		// matches scrollbar in document/viewport/element
		// I expect this will _have_ to leak subpixels given we are measuring with clientRect

	let t0 = performance.now()
	try {
		let aList = [
			'button','checkbox','color','date','datetime-local','details','directory',
			'file','files','number','radio','reset','select','select_multiple','submit','time'
		]
		let aSelect = ['empty','spaces','string']
		let oData = {}, target, oSelect = {}
		aList.sort()
		aSelect.sort()
		aList.forEach(function(n) {
		 if (n == "select_multiple") {
				// note: number of options makes no difference
				aSelect.forEach(function(n) {
					target = dom['eselect'+n]
					oSelect[n] = [target.getBoundingClientRect().width, target.getBoundingClientRect().height]
					target = dom["opt"+n]
					oSelect[n+"_option"] = [target.getBoundingClientRect().width, target.getBoundingClientRect().height]
				})
				oData[n] = oSelect
			} else {
				target = dom['e'+n]
				oData[n] = [target.getBoundingClientRect().width, target.getBoundingClientRect().height]
			}
		})
		let hash = mini(oData), notation = ""
		// check windows 11 dpr = 1 (my machine)
		if (isFile) {
			notation = (hash == "535d1095" ? green_tick : red_cross)
		}
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		dom.elements.innerHTML = hash + notation + perf + "<br>"+ json_highlight(oData)
		return
	} catch(e) {
		dom.elements = e+""
		return
	}
}

function get_fonts() {
	let t0 = performance.now()
	Promise.all([
		get_default_proportional(),
		get_default_sizes(),
		get_font_sizes(),
		get_widget_fonts(),
	]).then(function(results){
		let oData = {}
		results.forEach(function(item) {
			let METRIC = item[0]
			if ("object" === typeof item[1]) {
				let hash = mini(item[1])
				oData[METRIC] = {"hash": hash, "metrics": item[1]}
			} else {
				oData[METRIC] = item[1]
			}
		})
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		let hash = mini(oData), notation = "", toggle = "fonts"
		// check windows 11 dpr = 1 (my machine)
		if (isFile) {
			notation = (hash == "91921f18" ? green_tick : red_cross)
		}
		dom.fontshash.innerHTML = hash + notation + perf
			+" <span id='labelhidden"+ toggle +"' class='btnfirst btn0' onClick=\"togglerows('hidden"+ toggle +"','expand')\">[ expand ]</span>"
		dom.fonts.innerHTML = "<span class='toghidden" + toggle +" hidden'>"+ json_highlight(oData) +"</span><br>"
	})
}

const get_isSystemFont = () => new Promise(resolve => {
	if (!isFF) {return resolve()}
	// first aFont per computed family
	let aFonts = ['-moz-button','-moz-button-group','-moz-desktop','-moz-dialog','-moz-document',
		'-moz-field','-moz-info','-moz-list','-moz-pull-down-menu','-moz-window','-moz-workspace',
		'caption','icon','menu','message-box','small-caption','status-bar'
	]
	baseFonts = [
		'monospace, Menlo, Consolas, Courier, \"Courier New\", Monaco, \"Lucida Console\"',
		'sans-serif, Arial',
		'serif, Times, Roman'
	]
	baseFonts = baseFonts.concat([
		'cursive','fantasy','fangsong','system-ui',
		'ui-monospace','ui-rounded','ui-serif','math','emoji','none' // redudnant not used in TZP but include here
	])
	baseFonts.sort()
	try {
		let el = dom.sysFont, data = []
		aFonts.forEach(function(font){
			el.style.font = font
			let family = getComputedStyle(el)["font-family"]
			if (!data.includes(family)) {
				data.push(family)
				isSystemFont.push(font)
			}
		})
		baseFonts = baseFonts.concat(isSystemFont)
		baseFonts.sort()
		return resolve()
	} catch(e) {
		return resolve()
	}
})

function get_locale() {
	// just get one
	let locale
	try {
		locale = Intl.DateTimeFormat().resolvedOptions().locale
	} catch(e) {
		locale = zErr
	}
	dom.locale.innerHTML = locale
}

function get_media_messages() {
	// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/MediaDocument.properties
	let t0 = performance.now()
	try {
		let mList = {
			"Invalid": "applang-invalid.png", // 0-byte file
			"Scaled": "applang-image.png",
			"Unsupported": "applang-unsupported.jpg",
				// ^ToDo: can't use jp2 etc because that prompts for user interaction
		}
		let mData = {}
		for (const k of Object.keys(mList)) {
			let target = dom["iframe-media"+k], title = ""
			if (k === "Scaled") {
				title = target.contentWindow.document.title
				//strip image name to reduce noise
				title = title.replace(mList[k], "")
			} else {
				try {
					const image = target.contentWindow.document.querySelector('img')
					title = image.alt
					title = title.replace(target.src, "") // remove noise
				} catch(err) {
					title = err+""
				}
			}
			title = title.trim()
			mData[k] = title
		}
		let hash = mini(mData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		dom.media_messages.innerHTML = hash + perf + "<br>"+ json_highlight(mData)
		return
	} catch(e) {
		dom.media_messages = e+""
		return
	}
}

function get_numeric_inputs() {
	let target = dom.enumber
	let oTests = {
		arab: ['٤','٦'],
		arabext: ['۴','۶'],
		latn: ['4',4,'6',6,],
		mymr: ['၄','၆'],
		x: ['x']
	}
	let oData = {}
	for (const k of Object.keys(oTests)) {
		oData[k] = {}
		oTests[k].forEach(function(n) {
			target.value = n
			let value = target.value
			let charName = "char", charValue, j = n
			if ("string" === typeof n) {
				charValue = n.charCodeAt(0)
			} else {
				charName = "number"; charValue = n; j = n +"n"
			}
			let validity = target.checkValidity()
			oData[k][j] = {}
			oData[k][j][charName] = charValue
			oData[k][j]["value"] = value
			oData[k][j]["validity"] = validity
		})
	}
	let toggle = "num"
	dom.numericinputhash.innerHTML = mini(oData)
		+" <span id='labelhidden"+ toggle +"' class='btnfirst btn0' onClick=\"togglerows('hidden"+ toggle +"','expand')\">[ expand ]</span>"
	dom.numeric_input.innerHTML = "<span class='toghidden" + toggle +" hidden'>"+ json_highlight(oData) +"</span><br>"
}

function get_validation_messages() {
	// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/dom/dom.properties
		// https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation
		// https://developer.mozilla.org/en-US/docs/Web/HTML/Constraint_validation
		// https://developer.mozilla.org/en-US/docs/Web/API/ValidityState
		// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input

	// tooLong + tooShort constraints require the user: https://developer.mozilla.org/en-US/docs/Web/API/ValidityState/tooShort
	// InvalidDate* - input types date/month/time/week in gecko fall back to type="text"
	let t0 = performance.now()
	try {
		const vList = {
			BadInputNumber: 'number', // this returns ValueMissing on chrome
			CheckboxMissing: 'checkbox',
			DateTimeRangeOverflow: 'datetime',
			DateTimeRangeUnderflow: 'datetimeunder',
			FileMissing: 'file',
			InvalidEmail: 'email',
			InvalidURL: "url",
			//InvalidDateMonth: '', // Please enter a valid month
			//InvalidDateTime: '', // Please enter valid date and time
			//InvalidDateWeek: '', // Please enter a valid week
			NumberRangeOverflow: 'max',
			NumberRangeUnderflow: 'min',
			PatternMismatch: 'tel',
			RadioMissing: 'radio',
			SelectMissing: 'select',
			StepMismatch: 'step',
			ValueMissing: 'text',
		}
		let vData = {}
		for (const k of Object.keys(vList).sort()) {
			try {
				if (vList[k] !== "") {
					let msg = dom["widget"+ vList[k]].validationMessage
					if (msg !== "") {
						vData[k] = msg
					}
				}
			} catch(e) {
				//console.log(k, e+"")
			}
		}
		let hash = mini(vData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		dom.validation_messages.innerHTML = hash + perf +"<br>"+ json_highlight(vData)
		return
	} catch(e) {
		dom.validation_messages = e+""
		return
	}
}

const get_widget_fonts = (os = isOS) => new Promise(resolve => {
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input
	const METRIC = "widget_fonts"
	let oList = {
		'button': 'e',
		'checkbox': 'e',
		'color': 'e',
		'datetime': 'widget',
		'datetime-local': 'e',
		'email': 'widget',
		'file': 'e',
		'hidden': 'e',
		'image': 'e',
		'month': 'e',
		'number': 'e',
		'password': 'e',
		'radio': 'e',
		'range': 'e',
		'reset': 'e',
		'search': 'e',
		'select': 'e',
		'submit': 'e',
		'tel': 'widget',
		'text': 'widget',
		'textarea': 'e',
		'time': 'e',
		'url': 'widget',
		'week': 'e',
	}

	try {
		let oRes = {}
		for (const k of Object.keys(oList).sort()) {
			let el = dom[oList[k] + k]
			let key = getComputedStyle(el).getPropertyValue("font-family")
				+" "+ getComputedStyle(el).getPropertyValue("font-size")
			if (oRes[key] == undefined) {oRes[key] = [k]} else {oRes[key].push(k)}
		}
		let newobj = {}
		for (const k of Object.keys(oRes).sort()) {newobj[k] = oRes[k]}
		return resolve([METRIC, newobj])
	} catch(e) {
		return resolve([METRIC, zErr])
	}
})

function run() {
	// clear
	let items = document.getElementsByClassName("c")
	for(let i=0; i < items.length; i++) {
		items[i].innerHTML = "&nbsp"
	}
	if (!isFF) {
		dom.xml_errors = "gecko only"
	}
	// pause so users see change
	setTimeout(function() {
		get_locale()
		get_numeric_inputs()
		get_xml_errors()
		get_validation_messages()
		get_media_messages()
		get_elements()
		get_fonts()
	}, 170)
}

Promise.all([
	get_globals()
]).then(function(){
	get_locale()
	if (!isFF) {
		dom.xml_errors = "gecko only"
	} else {
		get_isSystemFont()
	}
})

function get_xml_errors() {
	if (!isFF) {return}
	// https://developer.mozilla.org/en-US/docs/Web/API/DOMParser/parseFromString
		// https://developer.mozilla.org/en-US/docs/Web/XML/XML_introduction
		// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/xmlparser.properties
		// https://www.w3.org/TR/xml/
	console.clear()
	let t0 = performance.now()
	const xmlList = {
		n02: 'a', // syntax error
		n03: '', // no root element found
		n04: '<>', // not well-formed
		n05: '<', // unclosed token
		n07: '<x></X>', // mismatched tag
		n08: '<x x:x="" x:x="">', // duplicate attribute
		n09: '<x></x><x', // junk after document element
		n11: '<x>&x;', // undefined entity
		n14: '<x>&#x0;', // reference to invalid character number
		n20: '<x><![CDATA[', // unclosed CDATA section
		n27: '<x:x>', // prefix not bound to a namespace
		n28: '<x xmlns:x=""></x>', // must not undeclare prefix
		n30: '<?xml v=""?>', // XML declaration not well-formed
	}
	try {
		let xmlData = {}, delimiter = ":"
		let parser = new DOMParser
		// 'application/xml','application/xhtml+xml','text/xml','image/svg+xml' : same errors
		for (const k of Object.keys(xmlList)) {
			try {
				let xmlDoc = parser.parseFromString(xmlList[k], 'application/xml')
				let xmlStr = (xmlDoc.getElementsByTagName('parsererror')[0].firstChild.textContent)
				//split into parts: works back to FF52 and works with LTR
					// the name (XML Parsing Error), location (Location) and line parts (Line Number 1, Column 1)
					// create entropy but they are the same for all errors, record these once to reduce noise
				let parts = xmlStr.split("\n")
				if (k == "n02") {
					// programatically determine delimiter
						// usually = ":" (charCode 58) but zh-Hans-CN = "：" (charCode 65306) and my = "-"
					let strLoc = parts[1]
					let schema = isFile ? "file://" : "https://"
					let index = strLoc.indexOf(schema) - 2
					if (strLoc.charAt(index + 1) !== " ") {index++} // zh-Hans-CN has no space: e.g. "位置：http://"
					if (strLoc.charAt(index) == " ") {index = index -1} // jfc: ms has a double space: "Lokasi:  http"
					delimiter = strLoc.charAt(index)
					strLoc = strLoc.slice(0, index)
					let strName = parts[0].split(delimiter)[0]
					let strLine = parts[2]
					xmlData["n00"] = strName +": " + strLoc +": "+ strLine // weird on LTR but who cares
					xmlData["n01"] = delimiter +" (" + delimiter.charCodeAt(0) +")"
					//console.log(xmlStr)
					//console.log(parts)
					//console.log(strLoc, schema, index, "~"+delimiter+"~")
					//console.log(mini(strName +": " + strLoc +": "+ strLine), strName +": " + strLoc +": "+ strLine)
				}
				xmlData[k] = parts[0].split(delimiter)[1].trim()
			} catch(err) {
				//console.log(k, err+"")
			}
		}
		let hash = mini(xmlData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		dom.xml_errors.innerHTML = hash + perf + "<br>"+ json_highlight(xmlData)
		console.clear()
		return
	} catch(e) {
		dom.xml_errors = e+""
		console.clear()
		return
	}
}


const get_font_sizes = () => new Promise(resolve => {
	/* https://github.com/abrahamjuliot/creepjs */
	const METRIC = "fontsizes_base"
	const fntSize = "512px"

	if (!isFF) {return resolve([METRIC, zNA])}
	try {
		const doc = document // or iframe.contentWindow.document
		const id = `font-fingerprint`
		const div = doc.createElement('div')
		div.setAttribute('id', id)
		doc.body.appendChild(div)
		doc.getElementById(id).innerHTML = `
			<style>
			#${id}-detector {
				--font: '';
				position: absolute !important;
				left: -9999px!important;
				font-size: ` + fntSize + ` !important;
				font-style: normal !important;
				font-weight: normal !important;
				font-stretch: normal !important;
				letter-spacing: normal !important;
				line-break: auto !important;
				line-height: normal !important;
				text-transform: none !important;
				text-align: left !important;
				text-decoration: none !important;
				text-shadow: none !important;
				white-space: normal !important;
				word-break: normal !important;
				word-spacing: normal !important;
				/* in order to test scrollWidth, clientWidth, etc. */
				padding: 0 !important;
				margin: 0 !important;
				/* in order to test inlineSize and blockSize */
				writing-mode: horizontal-tb !important;
				/* for transform and perspective */
				transform-origin: unset !important;
				perspective-origin: unset !important;
			}
			#${id}-detector::after {
				font-family: var(--font);
				content: '`+ fntString +`';
			}
			</style>
			<span id="${id}-detector"></span>`

		const span = doc.getElementById(`${id}-detector`)
		const style = getComputedStyle(span)
		const detectedViaDomRectClient = new Set()

		const getDimensions = (span, style) => {
			const dimensions = {
				height: span.getClientRects()[0].height,
				width: span.getClientRects()[0].width,
			}
			return dimensions
		}

		// base sizes
		const base = baseFonts.reduce((acc, font) => {
			if (isSystemFont.includes(font)) { // not a family
				span.style.setProperty('--font', "")
				span.style.font = font
			} else {
				span.style.font = ""
				span.style.setProperty('--font', font)
			}
			const dimensions = getDimensions(span, style)
			acc[font.split(",")[0]] = dimensions // use only first name, i.e w/o fallback
			return acc
		}, {})

		// tidy base: reorder in groups based on hash
		let oTempBase = {}
		for (const k of Object.keys(base)) {
			let tmpHash = mini(base[k])
			if (oTempBase[tmpHash] == undefined) {
				oTempBase[tmpHash] = {"bases" : [k], "data" : base[k]}
			} else {
				oTempBase[tmpHash]["bases"].push(k)
			}
		}
		span.style.font = "" // reset
		try {document.getElementById(id).remove()} catch(e) {} // remove element
		return resolve([METRIC, oTempBase])
	} catch(e) {
		try {document.getElementById(id).remove()} catch(e) {} // remove element
		return resolve([METRIC, e+""])
	}
})


</script>
</body>
</html>
