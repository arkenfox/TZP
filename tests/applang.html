<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=800">
	<title>app language</title>
  <link rel="stylesheet" type="text/css" href="testindex.css">
  <script src="testglobals.js"></script>
  <script src="testgeneric.js"></script>
	<style>
		table {width: 780px;}
	</style>
</head>

<body>
	<!-- offscreen -->
	<div class="offscreen">
		<div>
			<!-- applang-image.png can't be hidden otherwise "Scaled..." is not in the title -->
			<iframe id="iframe-mediaInvalid" width="100" height="30" src="applang-invalid.png"></iframe>
			<iframe id="iframe-mediaScaled" width="100" height="30" src="applang-image.png"></iframe>
			<iframe id="iframe-mediaUnsupported" width="100" height="30" src="applang-unsupported.jp2"></iframe>
		</div>
	</div>
	<div class="hidden">
		<div>
			<input type="text" required id="widgettext">
			<input type="checkbox" required id="widgetcheckbox">
			<select required id="widgetcombobox"><option></option></select>
			<input type="date" id="widgetdatetime" value="2024-01-01" max="2023-01-01">
			<input type="date" id="widgetdatetimeunder" value="2022-01-01" min="2023-01-01">
			<input type="email" id="widgetemail" value="a">
			<input type="file" required id="widgetfile">
			<input type="number" required id="widgetnumber">
			<input type="number" id="widgetmax" max="2" value="3">
			<input type="number" id="widgetmin" min="2" value="1">
			<input type="number" id="widgetstep" min="2" step="2" value="3">
			<input type="radio" required name="radiogroup" id="widgetradio">
			<input type="url" id="widgeturl" value="a">
			<input type="tel" id="widgettel" pattern="[0-9]{1}" value="a">
		</div>
		<iframe id="iframeTest"></iframe>
		<iframe id="appLang_2"></iframe>
		<iframe id="appLang_3"></iframe>
	</div>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<!-- app lang -->
	<table id="tb4">
		<col width="18%"></a><col width="82%">
		<thead><tr><th colspan="2">application language</th></tr></thead>
		<tr><td><div>
			<div class="btn-left"><span class="btn4 btn" id="runbutton" onClick="run()">[ run ]</span></div>
			<div>dtd <sup>1</sup></div></div></td><td class="c mono" id="appLang2"></td></tr>
		<tr><td>dtd nullprinciple <sup>2</sup></td><td class="c mono" id="appLang3"></td></tr>

		<tr><td>media messages <sup>3</sup></td><td class="c mono spaces" id="media_messages"></td></tr>
		<tr><td>validation errors <sup>3</sup></td><td class="c mono spaces" id="validation_errors"></td></tr>
		<tr><td>xml errors <sup>3</sup></td><td class="c mono spaces" id="xml_errors"></td></tr>
		<!--credits-->
		<tr><td colspan="2"></td></tr>
		<tr><td colspan="2"><span class="no_color">app language code based on work by Alex Catarineu </span>
			<a target="_blank" class="blue" href="https://acatarineu.github.io/fp/locale.html">here</a> <sup>1</sup>
			<span class="no_color"> and </span>
			<a target="_blank" class="blue" href="https://acatarineu.github.io/fp/locale_nullprincipal.html">here</a> <sup>2</sup>
			<span class="no_color"> and </span>
			<a target="_blank" class="blue" href="https://trac.torproject.org/projects/tor/ticket/30683">z3t on HackerOne</a> <sup>3</sup>
			</td></tr>
		</table>
	<br>

<script>
'use strict';
var dtd2 = ""
// error notes
let se = sb+"[test error: ",
	error_file_cors = sn+"[file:] [Cross-Origin Request Blocked]"+sc,
	error_iframe = se+"iframe]"+sc,
	error_image = se+"image]"+sc,
	enUS_green = sg+"[en-US]</span> ",
	enUS_red = sb+"[en-US]</span> "

function test_iframe() {
	let iframeBlocked = true // assume blocked

	// test an iframe: if loaded call other functions
	function output_iframe() {
		// clear iframe
		iframe.src=""
		// output
		if (iframeBlocked == true) {
			if (isFile) {
				// file: Cross-Origin Request Blocked
				dom.appLang2.innerHTML = error_file_cors
			} else {
				// iframe is blocked
				dom.appLang2.innerHTML = error_iframe
			}
		} else {
			// iframes are good: call functions
			get_app_lang_dtd1()
		}
	}

	let iframe = dom.iframeTest
	iframe.src="applang-iframetest.html"
	iframe.addEventListener("load", function(){
		try {
			let testerror = iframe.contentWindow.document.getElementById("test")
			iframeBlocked = false
		} catch(e) {}
	})

	// keep checking iframe loaded, but stop after x tries
	let counter = 0
	function check_iframe() {
		if (counter < 60) {
			if (iframeBlocked == false) {
				clearInterval(checking)
				output_iframe()
			}
		} else {
			clearInterval(checking)
			output_iframe()
		}
		counter++
	}
	let checking = setInterval(check_iframe, isFile ? 1 : 50)
}

function get_app_lang_dtd1() {
	// only call if iframes != blocked: no result = bugzilla fix
	// FF70+ https://bugzilla.mozilla.org/show_bug.cgi?id=467035

	let dtd1 = ""
	function output_dtd1(output) {
		dom.appLang2.innerHTML = output
	}
	// load it
	let iframe = dom.appLang_2,
		dtdtemp = ""
	iframe.src="applang.xml"
	iframe.addEventListener('load', () => {
		try {
			dtd1 = iframe.contentDocument.getElementById("DTD1").innerText
		} catch(e) {
			if (isFile) {
				setTimeout(function() {
					dtdtemp = error_file_cors
				}, 1000) // get this done before the check_dtd1 runs out
			}
		}
	})
	// keep checking dtd1 != blank x times
	let counter = 0
	function check_dtd1() {
		if (counter < 30) {
			if (dtd1 !== "") {
				clearInterval(checking)
				// notate
				if (navigator.language == "en-US") {
					dtd1 = (mini(dtd1) == "b10660d1" ? enUS_green + dtd1 : enUS_red + dtd1)
				}
				output_dtd1(dtd1)
			}
		} else {
			clearInterval(checking)
			if (dtdtemp == "") {dtdtemp = sg +"[bugzilla 467035]"+ sc}
			output_dtd1(dtdtemp)
		}
		counter++
	}
	let checking = setInterval(check_dtd1, 50)
}

function get_app_lang_dtd2() {
	// dtd nullprinciple
	dtd2 = ""
	function output_dtd2(output) {
		dom.appLang3.innerHTML = output
		// as good a time as any to flip the button
		dom.runbutton.innerHTML = "[ re-run ]"
	}
	// load it up
	let iframe = dom.appLang_3
	// ? chrome://global/locale/netError.dtd

	iframe.src="data:application/xml;charset=utf-8,%3C%21DOCTYPE%20html%20SYSTEM%20%22chrome%3A%2F%2Fglobal%2Flocale%2FnetError.dtd%22%3E%3Chtml%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%3E%3Chead%3E%3Cmeta%20charset%3D%22utf-8%22%2F%3E%0D%0A%20%20%3C%2Fhead%3E%0D%0A%20%20%3Cbody%3E%3Cspan%20id%3D%22text-container%22%3E%26loadError.label%3B%3C%2Fspan%3E%0D%0A%20%20%3Cscript%3E%0D%0A%20%20window.addEventListener%28%27message%27%2C%20%28e%29%20%3D%3E%20%7B%0D%0A%20%20%20%20e.source.postMessage%28document.getElementById%28%27text-container%27%29.innerText%2C%20%27%2A%27%29%3B%0D%0A%20%20%7D%29%3B%0D%0A%20%20%3C%2Fscript%3E%0D%0A%20%20%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E";
	iframe.addEventListener('load', () => {
		window.addEventListener('message', ({ data }) => dtd2 = data)
		iframe.contentWindow.postMessage('foo', '*')
	})
	// keep checking dtd2 not blank, but stop after x tries
	let counter = 0
	function check_dtd2() {
		if (counter < 30) {
			if (dtd2 !== "") {
				console.log(dtd2)
				clearInterval(checking)
				// notate
				if (navigator.language == "en-US") {
					dtd2 = (mini(dtd2) == "b10660d1" ? enUS_green + dtd2 : enUS_red + dtd2)
				}
				output_dtd2(dtd2)
			}
		} else {
			clearInterval(checking)
			output_dtd2(sg +"[bugzilla 467035]"+ sc)
		}
		counter++
	}
	let checking = setInterval(check_dtd2, 50)
}

function get_media_messages() {
	// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/MediaDocument.properties
	let t0 = performance.now()
	try {
		let mList = {
			"Invalid": "applang-invalid.png", // 0-byte file
			"Scaled": "applang-image.png",
			"Unsupported": "applang-unsupported.jp2", // ToDo
		}
		let mData = {}
		for (const k of Object.keys(mList)) {
			let target = dom["iframe-media"+k], title = ""
			if (k === "Scaled") {
				title = target.contentWindow.document.title
				//strip image name to reduce noise
				title = title.replace(mList[k], "")
			} else {
				try {
					const image = target.contentWindow.document.querySelector('img')
					title = image.alt
					title = title.replace(target.src, "") // remove noise
				} catch(err) {
					title = err+""
				}
			}
			title = title.trim()
			mData[k] = title
		}
		let hash = mini(mData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		let alink = " <a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/MediaDocument.properties'"
			+" target='blank'>searchfox MediaDocument</a>"
		dom.media_messages.innerHTML = hash + perf + alink +"<br>"+ json_highlight(mData)
		return
	} catch(e) {
		dom.media_messages = e+""
		return
	}
}

function get_xml_errors() {
	// https://developer.mozilla.org/en-US/docs/Web/API/DOMParser/parseFromString
		// https://developer.mozilla.org/en-US/docs/Web/XML/XML_introduction
		// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/xmlparser.properties
		// https://www.w3.org/TR/xml/
	let t0 = performance.now()
	try {
		const xmlList = {
			"n02": 'a', // syntax error
			"n03": '', // no root element found
			"n04": '<>', // not well-formed
			"n05": '<?', // unclosed token
			"n07": '<x></X>', // mismatched tag
			"n08": '<x xmlns:x="." xmlns:x=".">', // duplicate attribute
			"n09": '<x></x><x>', // junk after document element
			"n11": '<x>&x;</x>', // undefined entity
			"n14": '<x>&#x0;', // reference to invalid character number
			"n20": '<x><![CDATA[', // unclosed CDATA section
			"n28": '<x xmlns:x=""></x>', // must not undeclare prefix
			"n30": '<?xml versin="1.0"?>', // XML declaration not well-formed
		}
		let xmlData = {}, delimiter = ":"
		for (const k of Object.keys(xmlList)) {
			try {
				let xmlDoc = (new DOMParser).parseFromString(xmlList[k], 'application/xml')
				let xmlStr = (xmlDoc.getElementsByTagName('parsererror')[0].firstChild.textContent)
				//split into parts: works back to FF52 and works with LTR
					// the name (XML Parsing Error), location (Location) and line parts (Line Number 1, Column 1)
					// create entropy but they are the same for all errors, record these once to reduce noise
				let parts = xmlStr.split("\n")
				if (k == "n02") {
					// programatically determine delimiter
						// usually = ":" (charCode 58) but zh-Hans-CN = "：" (charCode 65306) and my = "-"
					let strLoc = parts[1]
					let schema = isFile ? "file://" : "https://"
					let index = strLoc.indexOf(schema) - 2
					if (strLoc.charAt(index + 1) !== " ") {index++} // zh-Hans-CN has no space: e.g. "位置：http://"
					if (strLoc.charAt(index) == " ") {index = index -1} // jfc: ms has a double space: "Lokasi:  http"
					delimiter = strLoc.charAt(index)
					strLoc = strLoc.slice(0, index)
					let strName = parts[0].split(delimiter)[0]
					let strLine = parts[2]
					xmlData["n00"] = strName +": " + strLoc +": "+ strLine // weird on LTR but who cares
					xmlData["n01"] = delimiter +" (" + delimiter.charCodeAt(0) +")"
					//console.log(xmlStr)
					//console.log(parts)
					//console.log(strLoc, schema, index, "~"+delimiter+"~")
					//console.log(mini(strName +": " + strLoc +": "+ strLine), strName +": " + strLoc +": "+ strLine)
				}
				xmlData[k] = parts[0].split(delimiter)[1].trim()
			} catch(err) {
				console.log(k, err+"")
			}
		}
		let hash = mini(xmlData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		let alink = " <a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/layout/xmlparser.properties'"
			+" target='blank'>searchfox xmlparser</a>"
		dom.xml_errors.innerHTML = hash + perf + alink +"<br>"+ json_highlight(xmlData)
		return
	} catch(e) {
		dom.xml_errors = e+""
		return
	}
}

function get_validation_errors() {
	// https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/dom/dom.properties
		// https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation
		// https://developer.mozilla.org/en-US/docs/Web/HTML/Constraint_validation
		// https://developer.mozilla.org/en-US/docs/Web/API/ValidityState
		// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input

	// tooLong + tooShort constraints require the user: https://developer.mozilla.org/en-US/docs/Web/API/ValidityState/tooShort
	// InvalidDate* - input types date/month/time/week in gecko fall back to type="text"
	let t0 = performance.now()
	try {
		const vList = {
			BadInputNumber: 'number', // this returns ValueMissing on chrome
			CheckboxMissing: 'checkbox',
			DateTimeRangeOverflow: 'datetime',
			DateTimeRangeUnderflow: 'datetimeunder',
			FileMissing: 'file',
			InvalidEmail: 'email',
			InvalidURL: "url",
			//InvalidDateMonth: '', // Please enter a valid month
			//InvalidDateTime: '', // Please enter valid date and time
			//InvalidDateWeek: '', // Please enter a valid week
			NumberRangeOverflow: 'max',
			NumberRangeUnderflow: 'min',
			PatternMismatch: 'tel',
			RadioMissing: 'radio',
			SelectMissing: 'combobox',
			StepMismatch: 'step',
			ValueMissing: 'text',
		}
		let vData = {}
		for (const k of Object.keys(vList)) {
			try {
				if (vList[k] !== "") {
					let msg = dom["widget"+ vList[k]].validationMessage
					if (msg !== "") {
						vData[k] = msg
					}
				}
			} catch(e) {
				//console.log(k, e+"")
			}
		}
		let hash = mini(vData)
		let perf = " ["+ Math.round(performance.now() - t0) +" ms]"
		let alink = " <a class='blue' href='https://searchfox.org/mozilla-central/source/dom/locales/en-US/chrome/dom/dom.properties'"
			+" target='blank'>searchfox dom.properties</a>"
		dom.validation_errors.innerHTML = hash + perf + alink + "<br>"+ json_highlight(vData)
		return
	} catch(e) {
		dom.validation_errors = e+""
		return
	}
}

function run() {
	if (!isFF) {
		dom.validation_errors.innerHTML = "&nbsp"
	} else {
		// clear
		let items = document.getElementsByClassName("c")
		for(let i=0; i < items.length; i++) {
			items[i].innerHTML = "&nbsp"
		}
	}
	// pause so users see change
	setTimeout(function() {
		get_validation_errors()
		// FF only
		if (!isFF) {return}
		get_xml_errors()
		get_media_messages() // testing

		get_app_lang_dtd2()
		test_iframe() // fires last two PoCs
	}, 170)
}

Promise.all([
	get_globals()
]).then(function(){
	if (!isFF) {
		let str = "gecko only"
		dom.appLang2 = str
		dom.appLang3 = str
		dom.media_messages = str
		dom.xml_errors = str
	}
})

</script>
</body>
</html>
