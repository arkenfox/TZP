<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=600">
	<title>engine</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 580px;}
		#tb3 td:first-child { text-align: left; vertical-align: top;}
		hr {color: #dcc18c}
	</style>
</head>

<body>
	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html">return to TZP index</a></td></tr>
	</table>

	<table id="tb3">
		<col width="50%"><col width="50%">
		<thead><tr><th colspan="2">engine</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">An eeny-weeny, teeny-weeny minuscule sample of the thousands of myriad ways engines differ.
			This test is tweaked for gecko [FF68+]: you want <span class="s9"> &#x2713 </span>'s. Anything different
			<span class="bad"> &#x2716 </span> or blocked <span class="bad"> &#x25cf </span> only makes you stand out.
			</span>
		</td></tr>
		<tr><td colspan="2"><hr></td></tr>
		<tr><td colspan="2"><span class="no_color c mono spaces" id="results"></span></td></tr>
	</table>
	<br>

<script>
'use strict';

s3 = s3.trim()
s14 = s14.trim()
sb = sb.trim()
sg = sg.trim()
let results = [],
	data = {},
	count = 0,
	errcount = 0,
	expected = 38

function standardize(str) {
	str = str.replace(/(\r\n|\n|\r)/gm,"")
	if (str.length > 70) {str = str.slice(0,67) +"..."}
	return str
}

function display() {
	// data -> ordered results
	const names = Object.keys(data).sort((a,b) => a-b)
	for (const k of names) {results.push(data[k])}
	let display = []
	let countTrue = 0, countFalse = 0, countBlock = 0, countNA = 0
	// check no numbers duplicated
	if (expected !== results.length) {
		display.push(sb+ "ERROR:"+ sc + " duplicate numbers detected<br>")
	}
	// parse for pretty output
	for (let i=0; i < results.length; i++) {
		let pad = 29
		let desc = results[i].split("~~~")[0].trim(),
			result = results[i].split("~~~")[1],
			match = results[i].split("~~~")[2]
		if (desc == "header") {
			let note = ""
			if (result == "errors") {
				note = " [there are thousands of these]"
			}
			result = s14 + result.toUpperCase() + sc + note
			display.push("<span>"+ result + "</span><br>")
		} else if (desc == "hr") {
			display.push("<br><hr>")
		} else {
			if (match == zB0) {match = red_block; countBlock++
			} else if (match == "true") {match = green_tick; countTrue++
			} else if (match == "false") {match = red_cross; countFalse++
			} else {match = "-"; countNA++}
			match += " "
			if (desc == "error") {
				pad = 3; errcount++; desc = errcount.toString()
			}
			desc = s3 + desc.padStart(pad) + sc
			let sectionspace = ""
			if (i+1 < results.length) {
				let nextitem = results[i+1].split("~~~")[0].trim()
				if (nextitem == "header") {sectionspace = "<br>"}
			}
			display.push(desc + match +" "+ result + sectionspace)
		}
	}
	// summary
	let countValid = countTrue + countFalse + countBlock // na tests ignored
	let countFail = countFalse + countBlock
	let percentPassed = Math.floor((countTrue/countValid)*100)
	let isPass = percentPassed == 100 ? true : false
	let percentFailed = Math.ceil((countFail/countValid)*100)
	let summary = s14 +"SUMMARY"+ sc
		+"PASSED: ".padStart(10) + countTrue + (isPass? sg : sb) +" ["+ percentPassed +"%]"+ sc
		+"FAILED: ".padStart(10) + countFail + (isPass? sg : sb) +" ["+ percentFailed +"%]"+ sc
	if (countNA > 0) {summary += "NA: ".padStart(6) + countNA}
	// output
	dom.results.innerHTML = summary + "<br><br>" + display.join("<br>")
}

function record(order, description, result, match) {
	order = (order+"").padStart(3,"0")
	data[order] = description +"~~~"+ result +"~~~"+ match
	count ++
	if (count == expected) {
		display()
	}
	//console.debug(count, order, description)
	if (count > expected) {console.error(count, "expected count too low")}
}

function compute() {
	// HEADERS
	record(0, "header", "expected")
	record(300, "header", "not expected")
	record(600, "header", "specific values")
	record(899, "hr")
	record(900, "header", "errors")

	// 0+: EXPECTED
	// 20, 21, 22 = error columnNumber, fileName, lineNumber
	let strIT1 = "[window] InstallTrigger", testIT1 = false
	try {
		testIT1 = "InstallTrigger" in window
		record (52, strIT1, testIT1, testIT1)
	} catch (e) {
		record(52, strIT1, e.name, zB0)
	}
	let strIT2 = "[typeof] InstallTrigger", testIT2 = false
	try {
		let resIT2 = typeof InstallTrigger
		if (resIT2 == "object") {testIT2 = true}
		record (51, strIT2, resIT2, testIT2)
	} catch (e) {
		record(51, strIT2, e.name, zB0)
	}
	let strIT3 = "[typeof] InstallTriggerImpl", testIT3 = false
	try {
		let resIT3 = typeof InstallTriggerImpl
		if (resIT3 == "function") {testIT3 = true}
		record (53, strIT3, resIT3, testIT3)
	} catch (e) {
		record(53, strIT3, e.name, zB0)
	}
	// keys
	let strMCanvas = "[2d canvas] keys", testMCanvas = false
	try {
		let aMCanvas = []
		let aMCanvasGood = ['mozCurrentTransform', 'mozCurrentTransformInverse', 'mozImageSmoothingEnabled', 'mozTextStyle']
		for (const key in CanvasRenderingContext2D.prototype) {aMCanvas.push(key)}
		aMCanvas = aMCanvas.filter(x => aMCanvasGood.includes(x))
		aMCanvas.sort()
		let resMCanvas = "none"
		if (aMCanvas.length > 0) {
			resMCanvas = sha1(aMCanvas.join())
			if (resMCanvas == "f2821c307f0190b324b9eb1dd36da9e40aadc852") {testMCanvas = true}
			resMCanvas += s3 +" ["+ aMCanvas.length +"]"+ sc
		}
		record(80, strMCanvas, resMCanvas, testMCanvas)
	} catch(e) {
		record(80, strMCanvas, e.name, zB0)
	}
	let strNavKeysExpected = "[navigator] keys"
	let strNavKeysNotExpected = "[navigator] keys"
	try {
		let aNavKeys = Object.keys(Object.getOwnPropertyDescriptors(Navigator.prototype))
		// expected FF only
		let aNavExpected = ["buildID","oscpu","taintEnabled"]
		let aNavCheckE = aNavKeys.filter(x => aNavExpected.includes(x))
		let resNavCheckE = aNavCheckE.length ? aNavCheckE.join(", ") : "none"
		let testNavCheckE = aNavCheckE.length == 3 ? true : false
		record(85, strNavKeysExpected, resNavCheckE, testNavCheckE)
		// not expected: blink items
		let aNavNotExpected = ["canShare","clearAppBadge","deviceMemory","getBattery","getInstalledRelatedApps",
			"getUserMedia","globalPrivacyControl","hid","keyboard","locks","managed","presentation",
			"requestMIDIAccess","scheduling","serial","setAppBadge","unregisterProtocolHandler",
			"usb","userActivation","userAgentData","wakeLock","webkitGetUserMedia","webkitPersistentStorage",
			"webkitTemporaryStorage","xr","SharedWorker","Worker"]
		let aNavCheckNotE = aNavKeys.filter(x => aNavNotExpected.includes(x))
		let resNavCheckNotE = sha1(aNavCheckNotE.join()) + s3 + " ["+ aNavCheckNotE.length +"]"+ sc
		if (aNavCheckNotE.length == 0) {resNavCheckNotE = "none"}
		record(350, strNavKeysNotExpected, resNavCheckNotE, aNavCheckNotE.length ? false : true)
	} catch(e) {
		console.debug(e.message)
		record(85, strNavKeysExpected, e.name, zB0)
		record(350, strNavKeysNotExpected, e.name, zB0)
	}

	// navigator
	let strNOscpu = "[oscpu] navigator", testNOscpu = false
	try {
		let resNOscpu = navigator.oscpu
		if (resNOscpu == "") {resNOscpu = "empty string"
		} else if (resNOscpu == undefined) {resNOscpu = "undefined"
		} else if (resNOscpu == "undefined") {resNOscpu = "undefined string"
		} else {testNOscpu = true}
		record (100, strNOscpu, resNOscpu, testNOscpu)
	} catch (e) {
		record(100, strNOscpu, e.name, zB0)
	}

	let strSleft = "[left] screen", testSleft = false
	try {
		let resSleft = screen.left
		if (!isNaN(resSleft)) {testSleft = true
		} else if (resSleft == "") {resSleft = "empty string"
		} else if (resSleft == undefined) {resSleft = "undefined"
		} else if (resSleft == "undefined") {resSleft = "undefined string"}
		record (150, strSleft, resSleft, testSleft)
	} catch (e) {
		record(150, strSleft, e.name, zB0)
	}
	let strStop = "[top] screen", testStop = false
	try {
		let resStop = screen.top
		if (!isNaN(resStop)) {testStop = true
		} else if (resStop == "") {resStop = "empty string"
		} else if (resStop == undefined) {resStop = "undefined"
		} else if (resStop == "undefined") {resStop = "undefined string"}
		record (151, strStop, resStop, testStop)
	} catch (e) {
		record(151, strStop, e.name, zB0)
	}
	let strWmozX = "[mozInnerScreenX] window", testWmozX = false
	try {
		let resWmozX = window.mozInnerScreenX
		if (!isNaN(resWmozX)) {testWmozX = true
		} else if (resWmozX == "") {resWmozX = "empty string"
		} else if (resWmozX == undefined) {resWmozX = "undefined"
		} else if (resWmozX == "undefined") {resWmozX = "undefined string"}
		record (250, strWmozX, resWmozX, testWmozX)
	} catch (e) {
		record(250, strWmozX, e.name, zB0)
	}
	let strWmozY = "[mozInnerScreenY] window", testWmozY = false
	try {
		let resWmozY = window.mozInnerScreenY
		if (!isNaN(resWmozY)) {testWmozY = true
		} else if (resWmozY == "") {resWmozY = "empty string"
		} else if (resWmozY == undefined) {resWmozY = "undefined"
		} else if (resWmozY == "undefined") {resWmozY = "undefined string"}
		record (251, strWmozY, resWmozY, testWmozY)
	} catch (e) {
		record(251, strWmozY, e.name, zB0)
	}

	// 300+: NOT EXPECTED
	let strNvendor = "[vendor] navigator", testNvendor = false
	try {
		let resNvendor = navigator.vendor
		if (resNvendor == "") {resNvendor = "empty string"; testNvendor = true
		} else if (resNvendor == undefined) {resNvendor = "undefined"
		} else if (resNvendor == "undefined") {resNvendor = "undefined string"}
		record (400, strNvendor, resNvendor, testNvendor)
	} catch (e) {
		record(400, strNvendor, e.name, zB0)
	}
	let strWChrome = "[chrome] window", testWChrome = false
	try {
		testWChrome = "chrome" in window
		record (450, strWChrome, testWChrome, !testWChrome)
	} catch (e) {
		record(450, strWChrome, e.name, zB0)
	}

	// 600+: SPECIFIC VALUES
	// 650: recursion error
	let strEvalLen = "eval.toString().length", testEvalLen = false
	try {
		let resEvalLen = eval.toString().length
		if (resEvalLen == 37) {testEvalLen = true}
		record (670, strEvalLen, resEvalLen, testEvalLen)
	} catch(e) {
		record (670, strEvalLen, e.name, zB0)
	}
	get_math() // 690
	let strNbuild = "[buildID] navigator", testNbuild = false
	try {
		let resNbuild = navigator.buildID
		if (resNbuild == "20181001000000") {testNbuild = true
		} else if (resNbuild == "") {resNbuild = "empty string"
		} else if (resNbuild == undefined) {resNbuild = "undefined"
		} else if (resNbuild == "undefined") {resNbuild = "undefined string"}
		record (700, strNbuild, resNbuild, testNbuild)
	} catch (e) {
		record(700, strNbuild, e.name, zB0)
	}
	let strNsub = "[productSub] navigator", testNsub = false
	try {
		let resNsub = navigator.productSub
		if (resNsub == "20100101") {testNsub = true
		} else if (resNsub == "") {resNsub = "empty string"
		} else if (resNsub == undefined) {resNsub = "undefined"
		} else if (resNsub == "undefined") {resNsub = "undefined string"}
		record (701, strNsub, resNsub, testNsub)
	} catch (e) {
		record(701, strNsub, e.name, zB0)
	}

	//
	get_stacklength()
	get_errors()


}

function get_errors() {
	// 900+: errors
	// 901 = recursion
	let errTests = [
		["var a = {}; a.b = a; JSON.stringify(a)", "TypeError: cyclic object value", ""],
		["alert('A)","SyntaxError: '' literal not terminated before end of script", ""],
		["null.value = 1","TypeError: can't access property \"value\" of null", "TypeError: null has no properties"],
		["let a = 1_00_;","SyntaxError: underscore can appear only between digits, not after t...",
			"SyntaxError: identifier starts immediately after numeric literal"],
		["const foo;foo.bar","SyntaxError: missing = in const declaration",""],
		["null.bar","TypeError: can't access property \"bar\" of null","TypeError: null has no properties"],
		["(1).toString(1000)","RangeError: radix must be an integer at least 2 and no greater than 36",""],
		["var x = new Array(-1)","RangeError: invalid array length",""],
		["[...undefined].length","TypeError: can't access property Symbol.iterator of undefined","TypeError: undefined has no properties"],
		["const tzp=1; const tzp=2;","SyntaxError: redeclaration of const tzp",""],
		["const foo;foo.bar","SyntaxError: missing = in const declaration",""],
	]
	let errNo = 902
	errTests.forEach(function(array) {
		try {
			eval(array[0])
		} catch(e) {
			let errTest = false
			let errStr = standardize(e.name +": "+ e.message)
			if (errStr == array[1]) {errTest = true}
			if (array[2] !== "") {
				if (errStr == array[2]) {errTest = true}
			}
			record(errNo, "error", errStr, errTest)
			errNo++
		}
	})
}

function get_math() {
	// polyfill
	function cbrt(x) {
		try {
			let y = Math.pow(Math.abs(x), 1 / 3)
			return x < 0 ? -y : y
		} catch(e) {
			return "error"
		}
	}
	try {
		let res = []
		for(let i=0; i < 6; i++) {
			try {
				let fnResult = "unknown"
				if (i == 0) {fnResult = cbrt(Math.PI) // polyfill
				} else if (i == 1) {fnResult = Math.log10(7*Math.LOG10E)
				} else if (i == 2) {fnResult = Math.log10(2*Math.SQRT1_2)
				} else if (i == 3) {fnResult = Math.acos(0.123)
				} else if (i == 4) {fnResult = Math.acosh(Math.SQRT2)
				} else if (i == 5) {fnResult = Math.atan(2)
				}
				res.push(fnResult)
			} catch(e) {
				res.push("error")
			}
		}
		let hash = sha1(res.join()).substring(0,20)
		let engine = ""
    if (hash == "ede9ca53efbb1902cc21") {engine = "blink"
		} else if (hash == "05513f36d87dd78af60a") {engine = "webkit"
		} else if (hash == "38172d9426d77af71baa") {engine = "edgeHTML"
		} else if (hash == "36f067c652c8cfd90725") {engine = "trident"
		} else if (hash == "225f4a612fdca4065043") {engine = "gecko"
		} else if (hash == "cb89002a8d6fabf859f6") {engine = "gecko"
		}

		let testEngine = engine == "gecko" ? true : false
		if (testEngine) {
			// full hash for gecko
			hash = sha1(res.join())
		} else {
			// trimmed hash + notation for non-gecko
			hash += "... "
			if (engine == "") {hash += sb +"[that's dodgy]"+sc
			} else {hash += s3 +"["+ engine +"]"+sc}
		}
		record(690, "math", hash, testEngine)
	} catch(e) {
		console.debug(e.message)
		record(690, "math", e.name, zB0)
	}
}

function get_stacklength() {
	let level = 0, test1 = 0
	function recurse() {
		level++
		recurse()
	}
	try {
		recurse()
	} catch (e) {
		test1 = level
	}
	level = 0
	try {
		recurse()
	} catch (e) {
		// columnNumber
		try {
			let strCN = "[columnNumber] error", errCN = false
			let resCN = e.columnNumber
			let testCN = resCN == undefined? false : true
			record(20, strCN, resCN, testCN)
		} catch(n) {
			record(20, strCN, resCN, zB0)
		}
		// fileName
		try {
			let strFN = "[fileName] error", errFN = false
			let resFN = e.fileName
			if (resFN !== undefined) {resFN = resFN.slice(0,8) + "..."}
			let testFN = resFN == undefined? false : true
			record(21, strFN, resFN, testFN)
		} catch(n) {
			record(21, strFN, resFN, zB0)
		}
		// lineNumber
		try {
			let strLN = "[lineNumber] error", errLN = false
			let resLN = e.lineNumber
			let testLN = resLN == undefined? false : true
			record(22, strLN, resLN, testLN)
		} catch(n) {
			record(22, strLN, resFN, zB0)
		}
		let strRE = "error", resRE = e.name +": "+ e.message
		if (resRE == "InternalError: too much recursion") {
			record(901, strRE, resRE, true)
		} else {
			record(901, strRE, resRE, false)
		}
		let strSL = "stack length", testSL = false
		let resSL = e.stack.toString().length
		if (resSL == 8064) {testSL = true}
		record (800, strSL, resSL, testSL)
	}
}

setTimeout(function() {
	compute()
}, 100)

</script>
</body>
</html>
