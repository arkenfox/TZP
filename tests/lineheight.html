<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=800">
	<title>line-height</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<style>
		table {width: 97%; min-width: 580px; max-width: 780px}
		hr {color: var(--test15);}
	</style>
</head>

<body>
	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html#elements">return to TZP index</a></td></tr>
	</table>

	<table id="tb15">
		<col width="15%"><col width="85%">
		<thead><tr><th colspan="2">
			<div class="nav-title">line-height
				<div class="nav-up"><span class="c perf" id="perf"></span></div>
			</div>
		</th></tr></thead>
		<tr><td colspan="2" class="intro">
			<span class="no_color">basic line-height test, using clientrect, with different variables</span>
			<span class="btn15 btn" onClick="run()">[ re-run ]</span>
				<input type="checkbox" name="expand" style="margin: 0; height: 12px" onClick='run()'> <span class="no_color">expand font-styles
			</span> &nbsp
			<span class="measure">
				<span class="cursive">.</span>
				<span class="fangsong">.</span>
				<span class="monospace">.</span>
				<span class="sans-serif">.</span>
				<span class="serif">.</span>
				<span class="system-ui">.</span>
			</span>
		</td></tr>
		<tr>
			<td colspan="2" style="text-align: left;">
			<hr><br>
			<!--
			<span class="no_color c mono spaces" id="summary"><b><u>SUMMARY</u></b></span>
			<br><br><hr><br>-->
			<span class="no_color c mono spaces" id="results"></span></td>
		</tr>

	</table>
	<br>

<script>
'use strict';

let oEverything = {}

sb = sb.trim()
sg = sg.trim()
s6 = s6.trim()
s15 = s15.trim()

function logConsole(group, name) {
	let logStr = group.toUpperCase() +": "+ name
	let data = oEverything[group][name]
	let results = JSON.stringify(data, null, 2)
	console.log(logStr +": "+ mini(data), "\n", data, "\n", results)
}

function get_lh() {
	let t0 = performance.now()
	let sizetypes = ["px","pt"]
	sizetypes.sort()
	let fonts = [
		// https://developer.mozilla.org/en-US/docs/Web/CSS/font-family#values
		'cursive',
		'emoji',
		'fangsong',
		'fantasy',
		'monospace',
		'sans-serif',
		'serif',
		'system-ui',
		'ui-serif',
	]
	if (dom.expand.checked) {
		fonts.push(
			'none',
			'math',
			'ui-monospace',
      "ui-sans-serif",
      "ui-rounded",
		)
	}
	fonts.sort()
	const sizes = [1,16,93,203,333] //,417,513,595,709,811,867,993]

	// reset
	oEverything = {}
	let display = []
	let oLine = {}
	let isLine = true

	try {
		let target
		sizetypes.forEach(function(sizetype) {

			// create per sizetype div + elements
			let id = "lh-fingerprint-"+ sizetype
			try {
				let doc = document
				let div = doc.createElement('div')
				div.setAttribute('id', id)
				doc.body.appendChild(div)
				div.classList.add("measure")
				let divcontent = ""
				fonts.forEach(function(fontfamily) {
					divcontent += "<div class='"+ fontfamily +"'>"
					sizes.forEach(function(size) {
						divcontent += "<div style='font-size:"+ size + sizetype +";' id='lh"
							+ fontfamily + size + sizetype +"' class='measureScale'>.</div>"
					})
					divcontent += "</div>"
				})
				doc.getElementById(id).innerHTML = divcontent
			} catch(e) {
				try {document.getElementById(id).remove()} catch(e) {} // remove element
				isLine = false
				dom.results.innerHTML = e.name +": " + e.message
				return
			}

			let oTempValues = {},
				oTempStyles = {},
				oTempData = {}
				oLine[sizetype] = {}
			fonts.forEach(function(fontfamily) {
				sizes.forEach(function(size) {
					size += sizetype
					if (isLine) {
						target = dom["lh"+ fontfamily + size]
						try {
							let elDiv = target.getBoundingClientRect()
							let height = elDiv.height
							if (oLine[sizetype][fontfamily] == undefined) {oLine[sizetype][fontfamily] = {}}
							oLine[sizetype][fontfamily][size] = height
						} catch(e) {
							isLine = false
							dom.results.innerHTML = e.name +": " + e.message
						}
					}
				})
			})
			try {document.getElementById(id).remove()} catch(e) {console.log(e.name, e.message)} // remove element
		})
	} catch(e) {
		isLine = false
		dom.results.innerHTML = e.name +": " + e.message
	}

	// errors
	if (isLine == false) {
		try {document.getElementById("lh-fingerprint-pt").remove()} catch(e) {} // remove element
		try {document.getElementById("lh-fingerprint-px").remove()} catch(e) {} // remove element
		return
	}

	sizetypes.forEach(function(sizetype) {
		oEverything[sizetype] = {}
		// hash/sort
		let tmpobj = {}, newobj = {}
		for (const k of Object.keys(oLine[sizetype])) {
			let hash = mini(oLine[sizetype][k])
			if (tmpobj[hash] == undefined) {
				tmpobj[hash] = {"group": [k], "metrics": oLine[sizetype][k]}
			} else {
				tmpobj[hash]["group"].push(k)
			}
		}

		let aGroups = []
		for (const k of Object.keys(tmpobj).sort()) {
			aGroups.push(tmpobj[k]["group"])
		}
		aGroups.sort()
		oEverything[sizetype]["groups"] = aGroups
		let grouphash = mini(aGroups)
		let groupHeader = "<b><u>"+ sizetype.toUpperCase() +"</u> " //+ </b>"
		if (sizetype !== sizetypes[0]) {groupHeader = "<hr><br>"+ groupHeader}
		let groupBtn = " group: "
			+ s15 + "<span class='btn15 btnc' onClick='logConsole(`"+ sizetype + "`,`groups`)'>" + grouphash + sc + sc
		groupHeader += groupBtn

		let tmpDisplay = []
		for (const k of Object.keys(tmpobj).sort()) {
			newobj[k] = tmpobj[k]
			let fontStr = newobj[k]["group"].join(", ")
			let aData = []
			for (const len of Object.keys(newobj[k]["metrics"])) {
				aData.push(newobj[k]["metrics"][len])
			}
			tmpDisplay.push(s6 + k + sc + ": <b>" + fontStr
				+"</b><p class='faint' style='margin: 5px 0px 0px 20px;'>"+ aData.join(", ") +"</p>")
		}
		let typehash = mini(newobj)
		oEverything[sizetype]["data"] = newobj
		let typeHashBtn = " hash: "
			+ s15 + "<span class='btn15 btnc' onClick='logConsole(`"+ sizetype + "`,`data`)'>" + typehash + sc + sc
		groupHeader += typeHashBtn
		groupHeader += "</br>"
		display.push(groupHeader)
		display = display.concat(tmpDisplay)
	})
	// display
	dom.results.innerHTML = display.join("<br>")
	// perf
	dom.perf.innerHTML = Math.round(performance.now() -t0) +" ms"


}

function run() {
	dom.results = ""
	dom.perf = ""
	setTimeout(function() {
		get_lh()
	}, 170)
}

dom.expand.checked = false
get_lh()

//make it easy to check all zoom values
if (isFile) {
	window.addEventListener("resize", get_lh)
}


</script>
</body>
</html>
